{"version":3,"file":"Keyboard.js","names":["event","domEvent","isCmd","isShift","Keyboard","constructor","config","eventBus","editorActions","_registerDefaultBindings","_fire","unbind","_listeners","i","l","listeners","code","keyCode","charCode","preventDefault","stopPropagation","node","_node","_keyHandler","_config","_eventBus","_editorActions","on","_destroy","_init","bindTo","bind","getBinding","fire","undo","key","modifiers","trigger","redo","push","addListener","listenerFn","unshift","removeListener","filter","$inject"],"sources":["../../../src/features/keyboard/Keyboard.js"],"sourcesContent":["import {\n  event as domEvent\n} from 'min-dom';\n\nimport {\n  isCmd,\n  isShift\n} from './KeyboardUtil';\n\n/**\n * A keyboard abstraction that may be activated and\n * deactivated by users at will, consuming key events\n * and triggering diagram actions.\n *\n * The implementation fires the following key events that allow\n * other components to hook into key handling:\n *\n *  - keyboard.bind\n *  - keyboard.unbind\n *  - keyboard.init\n *  - keyboard.destroy\n *\n * All events contain the fields (node, listeners).\n *\n * A default binding for the keyboard may be specified via the\n * `keyboard.bindTo` configuration option.\n *\n * @param {Config} config\n * @param {EventBus} eventBus\n * @param {EditorActions} editorActions\n */\nexport default class Keyboard {\n\n  constructor(config, eventBus, editorActions) {\n\n    this._config = config || {};\n    this._eventBus = eventBus;\n    this._editorActions = editorActions;\n\n    this._listeners = [];\n\n    eventBus.on('viewer.destroy', this._destroy);\n    eventBus.on('viewer.init', this._init);\n\n    eventBus.on('attach', () => {\n\n      if (this._config.bindTo) {\n        this.bind(config.bindTo);\n      }\n    });\n\n    eventBus.on('detach', this.unbind);\n  }\n\n  _init = () => {\n    this._registerDefaultBindings();\n\n    this._fire('init');\n  };\n\n  _destroy = () => {\n    this._fire('destroy');\n\n    this.unbind();\n    this._listeners = null;\n  };\n\n  // our key handler is a singleton that passes\n  // (keycode, modifiers) to each listener.\n  //\n  // listeners must indicate that they handled a key event\n  // by returning true. This stops the event propagation.\n  //\n  _keyHandler = (event) => {\n\n    var i, l,\n        listeners = this._listeners,\n        code = event.keyCode || event.charCode || -1;\n\n    for (i = 0; (l = listeners[i]); i++) {\n      if (l(code, event)) {\n        event.preventDefault();\n        event.stopPropagation();\n\n        return;\n      }\n    }\n  };\n\n  bind(node) {\n\n    // make sure that the keyboard is only bound once to the DOM\n    this.unbind();\n\n    this._node = node;\n\n    // bind key events\n    domEvent.bind(node, 'keydown', this._keyHandler, true);\n\n    this._fire('bind');\n  }\n\n  getBinding() {\n    return this._node;\n  }\n\n  unbind = () => {\n    var node = this._node;\n\n    if (node) {\n      this._fire('unbind');\n\n      // unbind key events\n      domEvent.unbind(node, 'keydown', this._keyHandler, true);\n    }\n\n    this._node = null;\n  };\n\n  _fire(event) {\n    this._eventBus.fire('keyboard.' + event, {\n      node: this._node,\n      listeners: this._listeners\n    });\n  }\n\n  _registerDefaultBindings() {\n\n    var listeners = this._listeners;\n\n    var editorActions = this._editorActions;\n\n    // init default listeners\n\n    // undo\n    // (CTRL|CMD) + Z\n    function undo(key, modifiers) {\n\n      if (isCmd(modifiers) && !isShift(modifiers) && key === 90) {\n        editorActions.trigger('undo');\n\n        return true;\n      }\n    }\n\n    // redo\n    // CTRL + Y\n    // CMD + SHIFT + Z\n    function redo(key, modifiers) {\n\n      if (\n        isCmd(modifiers) && (\n          key === 89 || (\n            key === 90 && isShift(modifiers)\n          )\n        )\n      ) {\n        editorActions.trigger('redo');\n\n        return true;\n      }\n    }\n\n    listeners.push(undo);\n    listeners.push(redo);\n  }\n\n\n  /**\n   * Add a listener function that is notified with (key, modifiers) whenever\n   * the keyboard is bound and the user presses a key.\n   *\n   * @param {Function} listenerFn\n   */\n  addListener(listenerFn) {\n    this._listeners.unshift(listenerFn);\n  }\n\n  removeListener(listenerFn) {\n    this._listeners = this._listeners.filter(l => l !== listenerFn);\n  }\n\n}\n\nKeyboard.$inject = [\n  'config.keyboard',\n  'eventBus',\n  'editorActions'\n];"],"mappings":"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"}
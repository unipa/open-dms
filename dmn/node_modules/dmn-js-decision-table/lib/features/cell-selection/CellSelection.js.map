{"version":3,"file":"CellSelection.js","names":["ensureFocus","findSelectableAncestor","getElementCoords","getElementId","getNodeByCoords","getNodeById","isUnselectableNode","LOW_PRIORITY","VALID_DIRECTIONS","above","below","right","left","CellSelection","config","eventBus","sheet","selection","elementRegistry","container","lastSelection","emit","elementId","newSelection","fire","click","event","target","selectableNode","focussed","defaultPrevented","realSelect","focus","stopPropagation","unfocus","selected","select","deselect","on","actualElement","oldSelection","id","oldElementId","isCellSelected","getCellSelection","selectCell","direction","Error","selectionEl","coords","nextCoords","getNextCoords","nextNode","nextElId","$inject","row","col","rowIndex","parseInt","isNaN","nextRowIndex","colIndex","nextColIndex"],"sources":["../../../src/features/cell-selection/CellSelection.js"],"sourcesContent":["import {\n  ensureFocus,\n  findSelectableAncestor,\n  getElementCoords,\n  getElementId,\n  getNodeByCoords,\n  getNodeById,\n  isUnselectableNode\n} from './CellSelectionUtil';\n\nconst LOW_PRIORITY = 500;\n\nconst VALID_DIRECTIONS = {\n  above: true,\n  below: true,\n  right: true,\n  left: true\n};\n\n\n/**\n * A cell selection utlity; allows selection of elements, independent from\n * whether they are backed by a business object or not.\n *\n * Works together with the {@link SelectionAware} trait.\n *\n * @param {RenderConfig} config\n * @param {EventBus} eventBus\n * @param {Sheet} sheet\n * @param {Selection} selection\n * @param {ElementRegistry} elementRegistry\n */\nexport default function CellSelection(\n    config, eventBus, sheet,\n    selection, elementRegistry) {\n\n  const {\n    container\n  } = config;\n\n  let lastSelection = null;\n\n  function emit(elementId, newSelection) {\n\n    eventBus.fire('selection.' + elementId + '.changed', newSelection);\n\n    eventBus.fire('cellSelection.changed', {\n      elementId: elementId,\n      selection: newSelection\n    });\n\n  }\n\n  function click(event) {\n\n    const target = event.target;\n\n    if (isUnselectableNode(target)) {\n      return;\n    }\n\n    const selectableNode = findSelectableAncestor(target);\n\n    const elementId = selectableNode && getElementId(selectableNode);\n\n    const focussed = !event.defaultPrevented;\n\n    realSelect(elementId, focussed);\n  }\n\n  function focus(event) {\n    const elementId = getElementId(event.target);\n\n    const focussed = !event.defaultPrevented;\n\n    event.stopPropagation();\n\n    return realSelect(elementId, focussed);\n  }\n\n  function unfocus(event) {\n    const elementId = getElementId(event.target);\n\n    emit(elementId, {\n      focussed: false\n    });\n  }\n\n  function realSelect(elementId, focussed = true) {\n\n    if (lastSelection !== elementId) {\n      emit(lastSelection, {\n        selected: false,\n        focussed: false\n      });\n    }\n\n    lastSelection = elementId;\n\n    if (elementId) {\n      emit(elementId, {\n        selected: true,\n        focussed\n      });\n    }\n\n    if (elementId) {\n      selection.select(elementId);\n    } else {\n      selection.deselect();\n    }\n  }\n\n  eventBus.on('cell.click', LOW_PRIORITY, click);\n  eventBus.on('cell.focusin', LOW_PRIORITY, focus);\n  eventBus.on('cell.focusout', LOW_PRIORITY, unfocus);\n\n  eventBus.on('cellSelection.changed', function(event) {\n\n    const {\n      elementId,\n      selection\n    } = event;\n\n    const actualElement = getNodeById(elementId, container);\n\n    if (selection.focussed && actualElement) {\n      ensureFocus(actualElement);\n    }\n  });\n\n  eventBus.on('selection.changed', function(event) {\n\n    const {\n      selection,\n      oldSelection\n    } = event;\n\n    var elementId = selection && selection.id;\n    var oldElementId = oldSelection && oldSelection.id;\n\n    // select new element\n    if (elementId && elementId !== lastSelection) {\n      realSelect(selection.id);\n    } else\n\n    // deselect old element\n    if (oldElementId && oldElementId === lastSelection) {\n      realSelect();\n    }\n\n  });\n\n  // API //////////////////////\n\n  /**\n   * Return true if a cell is currently selected.\n   *\n   * @return {boolean}\n   */\n  this.isCellSelected = function() {\n    return !!lastSelection;\n  };\n\n  /**\n   * Get the currently active cellSelection.\n   *\n   * @return {string} selection\n   */\n  this.getCellSelection = function() {\n    return lastSelection;\n  };\n\n  /**\n   * Select next cell in given direction.\n   *\n   * Returns true on success; false on fail (i.e. if no next selection\n   * in direction could be found).\n   *\n   * @param {string} direction\n   *\n   * @return {boolean}\n   */\n  this.selectCell = function(direction) {\n\n    if (!lastSelection) {\n      return;\n    }\n\n    if (!(direction in VALID_DIRECTIONS)) {\n      throw new Error('direction must be any of { above, below, left, right }');\n    }\n\n    var selectionEl = getNodeById(lastSelection, container);\n\n    const coords = getElementCoords(selectionEl);\n\n    if (!coords) {\n      return false;\n    }\n\n    const nextCoords = getNextCoords(coords, direction);\n\n    const nextNode = getNodeByCoords(nextCoords, container);\n\n    if (!nextNode) {\n      return false;\n    }\n\n    const nextElId = getElementId(nextNode);\n\n    if (nextElId) {\n      realSelect(nextElId, {\n        focussed: true,\n        selected: true\n      });\n    }\n\n    return true;\n  };\n\n\n  eventBus.on('contextMenu.close', function() {\n\n    if (lastSelection) {\n      return realSelect(lastSelection);\n    }\n\n  });\n\n}\n\nCellSelection.$inject = [\n  'config.renderer',\n  'eventBus',\n  'sheet',\n  'selection',\n  'elementRegistry'\n];\n\n\n\n// helpers ////////////////\n\nfunction getNextCoords(coords, direction) {\n\n  const {\n    row,\n    col\n  } = coords;\n\n  if (direction === 'above' || direction === 'below') {\n\n    const rowIndex = parseInt(row, 10);\n\n    if (isNaN(rowIndex)) {\n      return coords;\n    }\n\n    const nextRowIndex = direction === 'above' ? rowIndex - 1 : rowIndex + 1;\n\n    return {\n      col,\n      row: nextRowIndex\n    };\n  }\n\n  if (direction === 'left' || direction === 'right') {\n\n    const colIndex = parseInt(col, 10);\n\n    if (isNaN(colIndex)) {\n      return coords;\n    }\n\n    const nextColIndex = direction === 'left' ? colIndex - 1 : colIndex + 1;\n\n    return {\n      row,\n      col: nextColIndex\n    };\n  }\n\n  throw new Error('invalid direction <' + direction + '>');\n}"],"mappings":"AAAA,SACEA,WAAW,EACXC,sBAAsB,EACtBC,gBAAgB,EAChBC,YAAY,EACZC,eAAe,EACfC,WAAW,EACXC,kBAAkB,QACb,qBAAqB;AAE5B,MAAMC,YAAY,GAAG,GAAG;AAExB,MAAMC,gBAAgB,GAAG;EACvBC,KAAK,EAAE,IAAI;EACXC,KAAK,EAAE,IAAI;EACXC,KAAK,EAAE,IAAI;EACXC,IAAI,EAAE;AACR,CAAC;;AAGD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,eAAe,SAASC,aAAa,CACjCC,MAAM,EAAEC,QAAQ,EAAEC,KAAK,EACvBC,SAAS,EAAEC,eAAe,EAAE;EAE9B,MACEC,SAAS,GACPL,MAAM,CADRK,SAAS;EAGX,IAAIC,aAAa,GAAG,IAAI;EAExB,SAASC,IAAI,CAACC,SAAS,EAAEC,YAAY,EAAE;IAErCR,QAAQ,CAACS,IAAI,CAAC,YAAY,GAAGF,SAAS,GAAG,UAAU,EAAEC,YAAY,CAAC;IAElER,QAAQ,CAACS,IAAI,CAAC,uBAAuB,EAAE;MACrCF,SAAS,EAAEA,SAAS;MACpBL,SAAS,EAAEM;IACb,CAAC,CAAC;EAEJ;EAEA,SAASE,KAAK,CAACC,KAAK,EAAE;IAEpB,MAAMC,MAAM,GAAGD,KAAK,CAACC,MAAM;IAE3B,IAAIrB,kBAAkB,CAACqB,MAAM,CAAC,EAAE;MAC9B;IACF;IAEA,MAAMC,cAAc,GAAG3B,sBAAsB,CAAC0B,MAAM,CAAC;IAErD,MAAML,SAAS,GAAGM,cAAc,IAAIzB,YAAY,CAACyB,cAAc,CAAC;IAEhE,MAAMC,QAAQ,GAAG,CAACH,KAAK,CAACI,gBAAgB;IAExCC,UAAU,CAACT,SAAS,EAAEO,QAAQ,CAAC;EACjC;EAEA,SAASG,KAAK,CAACN,KAAK,EAAE;IACpB,MAAMJ,SAAS,GAAGnB,YAAY,CAACuB,KAAK,CAACC,MAAM,CAAC;IAE5C,MAAME,QAAQ,GAAG,CAACH,KAAK,CAACI,gBAAgB;IAExCJ,KAAK,CAACO,eAAe,EAAE;IAEvB,OAAOF,UAAU,CAACT,SAAS,EAAEO,QAAQ,CAAC;EACxC;EAEA,SAASK,OAAO,CAACR,KAAK,EAAE;IACtB,MAAMJ,SAAS,GAAGnB,YAAY,CAACuB,KAAK,CAACC,MAAM,CAAC;IAE5CN,IAAI,CAACC,SAAS,EAAE;MACdO,QAAQ,EAAE;IACZ,CAAC,CAAC;EACJ;EAEA,SAASE,UAAU,CAACT,SAAS,EAAmB;IAAA,IAAjBO,QAAQ,uEAAG,IAAI;IAE5C,IAAIT,aAAa,KAAKE,SAAS,EAAE;MAC/BD,IAAI,CAACD,aAAa,EAAE;QAClBe,QAAQ,EAAE,KAAK;QACfN,QAAQ,EAAE;MACZ,CAAC,CAAC;IACJ;IAEAT,aAAa,GAAGE,SAAS;IAEzB,IAAIA,SAAS,EAAE;MACbD,IAAI,CAACC,SAAS,EAAE;QACda,QAAQ,EAAE,IAAI;QACdN;MACF,CAAC,CAAC;IACJ;IAEA,IAAIP,SAAS,EAAE;MACbL,SAAS,CAACmB,MAAM,CAACd,SAAS,CAAC;IAC7B,CAAC,MAAM;MACLL,SAAS,CAACoB,QAAQ,EAAE;IACtB;EACF;EAEAtB,QAAQ,CAACuB,EAAE,CAAC,YAAY,EAAE/B,YAAY,EAAEkB,KAAK,CAAC;EAC9CV,QAAQ,CAACuB,EAAE,CAAC,cAAc,EAAE/B,YAAY,EAAEyB,KAAK,CAAC;EAChDjB,QAAQ,CAACuB,EAAE,CAAC,eAAe,EAAE/B,YAAY,EAAE2B,OAAO,CAAC;EAEnDnB,QAAQ,CAACuB,EAAE,CAAC,uBAAuB,EAAE,UAASZ,KAAK,EAAE;IAEnD,MACEJ,SAAS,GAEPI,KAAK,CAFPJ,SAAS;MACTL,SAAS,GACPS,KAAK,CADPT,SAAS;IAGX,MAAMsB,aAAa,GAAGlC,WAAW,CAACiB,SAAS,EAAEH,SAAS,CAAC;IAEvD,IAAIF,SAAS,CAACY,QAAQ,IAAIU,aAAa,EAAE;MACvCvC,WAAW,CAACuC,aAAa,CAAC;IAC5B;EACF,CAAC,CAAC;EAEFxB,QAAQ,CAACuB,EAAE,CAAC,mBAAmB,EAAE,UAASZ,KAAK,EAAE;IAE/C,MACET,SAAS,GAEPS,KAAK,CAFPT,SAAS;MACTuB,YAAY,GACVd,KAAK,CADPc,YAAY;IAGd,IAAIlB,SAAS,GAAGL,SAAS,IAAIA,SAAS,CAACwB,EAAE;IACzC,IAAIC,YAAY,GAAGF,YAAY,IAAIA,YAAY,CAACC,EAAE;;IAElD;IACA,IAAInB,SAAS,IAAIA,SAAS,KAAKF,aAAa,EAAE;MAC5CW,UAAU,CAACd,SAAS,CAACwB,EAAE,CAAC;IAC1B,CAAC;MAED;MACA,IAAIC,YAAY,IAAIA,YAAY,KAAKtB,aAAa,EAAE;QAClDW,UAAU,EAAE;MACd;EAEF,CAAC,CAAC;;EAEF;;EAEA;AACF;AACA;AACA;AACA;EACE,IAAI,CAACY,cAAc,GAAG,YAAW;IAC/B,OAAO,CAAC,CAACvB,aAAa;EACxB,CAAC;;EAED;AACF;AACA;AACA;AACA;EACE,IAAI,CAACwB,gBAAgB,GAAG,YAAW;IACjC,OAAOxB,aAAa;EACtB,CAAC;;EAED;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACE,IAAI,CAACyB,UAAU,GAAG,UAASC,SAAS,EAAE;IAEpC,IAAI,CAAC1B,aAAa,EAAE;MAClB;IACF;IAEA,IAAI,EAAE0B,SAAS,IAAItC,gBAAgB,CAAC,EAAE;MACpC,MAAM,IAAIuC,KAAK,CAAC,wDAAwD,CAAC;IAC3E;IAEA,IAAIC,WAAW,GAAG3C,WAAW,CAACe,aAAa,EAAED,SAAS,CAAC;IAEvD,MAAM8B,MAAM,GAAG/C,gBAAgB,CAAC8C,WAAW,CAAC;IAE5C,IAAI,CAACC,MAAM,EAAE;MACX,OAAO,KAAK;IACd;IAEA,MAAMC,UAAU,GAAGC,aAAa,CAACF,MAAM,EAAEH,SAAS,CAAC;IAEnD,MAAMM,QAAQ,GAAGhD,eAAe,CAAC8C,UAAU,EAAE/B,SAAS,CAAC;IAEvD,IAAI,CAACiC,QAAQ,EAAE;MACb,OAAO,KAAK;IACd;IAEA,MAAMC,QAAQ,GAAGlD,YAAY,CAACiD,QAAQ,CAAC;IAEvC,IAAIC,QAAQ,EAAE;MACZtB,UAAU,CAACsB,QAAQ,EAAE;QACnBxB,QAAQ,EAAE,IAAI;QACdM,QAAQ,EAAE;MACZ,CAAC,CAAC;IACJ;IAEA,OAAO,IAAI;EACb,CAAC;EAGDpB,QAAQ,CAACuB,EAAE,CAAC,mBAAmB,EAAE,YAAW;IAE1C,IAAIlB,aAAa,EAAE;MACjB,OAAOW,UAAU,CAACX,aAAa,CAAC;IAClC;EAEF,CAAC,CAAC;AAEJ;AAEAP,aAAa,CAACyC,OAAO,GAAG,CACtB,iBAAiB,EACjB,UAAU,EACV,OAAO,EACP,WAAW,EACX,iBAAiB,CAClB;;AAID;;AAEA,SAASH,aAAa,CAACF,MAAM,EAAEH,SAAS,EAAE;EAExC,MACES,GAAG,GAEDN,MAAM,CAFRM,GAAG;IACHC,GAAG,GACDP,MAAM,CADRO,GAAG;EAGL,IAAIV,SAAS,KAAK,OAAO,IAAIA,SAAS,KAAK,OAAO,EAAE;IAElD,MAAMW,QAAQ,GAAGC,QAAQ,CAACH,GAAG,EAAE,EAAE,CAAC;IAElC,IAAII,KAAK,CAACF,QAAQ,CAAC,EAAE;MACnB,OAAOR,MAAM;IACf;IAEA,MAAMW,YAAY,GAAGd,SAAS,KAAK,OAAO,GAAGW,QAAQ,GAAG,CAAC,GAAGA,QAAQ,GAAG,CAAC;IAExE,OAAO;MACLD,GAAG;MACHD,GAAG,EAAEK;IACP,CAAC;EACH;EAEA,IAAId,SAAS,KAAK,MAAM,IAAIA,SAAS,KAAK,OAAO,EAAE;IAEjD,MAAMe,QAAQ,GAAGH,QAAQ,CAACF,GAAG,EAAE,EAAE,CAAC;IAElC,IAAIG,KAAK,CAACE,QAAQ,CAAC,EAAE;MACnB,OAAOZ,MAAM;IACf;IAEA,MAAMa,YAAY,GAAGhB,SAAS,KAAK,MAAM,GAAGe,QAAQ,GAAG,CAAC,GAAGA,QAAQ,GAAG,CAAC;IAEvE,OAAO;MACLN,GAAG;MACHC,GAAG,EAAEM;IACP,CAAC;EACH;EAEA,MAAM,IAAIf,KAAK,CAAC,qBAAqB,GAAGD,SAAS,GAAG,GAAG,CAAC;AAC1D"}
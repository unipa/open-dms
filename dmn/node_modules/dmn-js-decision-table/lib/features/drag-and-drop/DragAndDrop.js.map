{"version":3,"file":"DragAndDrop.js","names":["classes","domClasses","domify","queryAll","domQueryAll","remove","domRemove","isInput","isOutput","Row","Col","forEach","TOP","RIGHT","BOTTOM","LEFT","DragAndDrop","constructor","components","elementRegistry","eventBus","dragAndDrop","renderer","rules","sheet","container","_renderer","getContainer","removeHighlight","removeFadeOut","_dragImage","_elementRegistry","_dragAndDrop","_rules","_sheet","onGetComponent","cellType","col","row","e","startDrag","title","on","event","dragContext","draggedElement","hoverEl","dropIndex","getTargetColIndex","allowed","index","targetEl","originalEvent","lastPosition","newPosition","getVerticalPosition","getHorizontalPosition","highlightRow","highlightCol","verticalPosition","rowId","dataset","get","targetRow","getTargetRow","getRoot","rows","horizontalPosition","colId","targetCol","getTargetCol","cols","_cleanup","element","document","body","appendChild","dataTransfer","setDragImage","fadeOutRow","fadeOutCol","$inject","cellEl","indexOf","dragOverCell","position","cells","cell","isNode","add","id","dragOverElement","bounds","getBoundingClientRect","clientX","left","width","clientY","top","height","draggedRow","getRowBelow","getRowAbove","draggedCol","getColRight","getColLeft","Math","max","min","length","firstOutput","filter","firstOutputIndex","inputs","lastInput","lastInputIndex","node","nodeType"],"sources":["../../../src/features/drag-and-drop/DragAndDrop.js"],"sourcesContent":["import {\r\n  classes as domClasses,\r\n  domify,\r\n  queryAll as domQueryAll,\r\n  remove as domRemove\r\n} from 'min-dom';\r\n\r\nimport { isInput, isOutput } from 'dmn-js-shared/lib/util/ModelUtil';\r\n\r\nimport { Row, Col } from 'table-js/lib/model';\r\n\r\nimport { forEach } from 'min-dash';\r\n\r\nconst TOP = 'top',\r\n      RIGHT = 'right',\r\n      BOTTOM = 'bottom',\r\n      LEFT = 'left';\r\n\r\n\r\nexport default class DragAndDrop {\r\n\r\n  constructor(\r\n      components, elementRegistry, eventBus,\r\n      dragAndDrop, renderer, rules, sheet) {\r\n\r\n    this._elementRegistry = elementRegistry;\r\n    this._dragAndDrop = dragAndDrop;\r\n    this._renderer = renderer;\r\n    this._rules = rules;\r\n    this._sheet = sheet;\r\n\r\n    // provide drag handle for drag and drop\r\n    components.onGetComponent('cell-inner', ({ cellType, col, row }) => {\r\n      if (cellType === 'rule-index') {\r\n        return () => <span\r\n          draggable=\"true\"\r\n          onDragStart={ e => this.startDrag(row, e) }\r\n          className=\"dmn-icon-drag vertical\"\r\n          title=\"Move rule\">&nbsp;</span>;\r\n      } else if (cellType === 'input-cell' || cellType === 'output-cell') {\r\n\r\n        let title = `Move ${isInput(col) ? 'Input' : 'Output' }`;\r\n\r\n        return () => <span\r\n          draggable=\"true\"\r\n          onDragStart={ e => this.startDrag(col, e) }\r\n          className=\"dmn-icon-drag horizontal\"\r\n          title={ title }></span>;\r\n      }\r\n    });\r\n\r\n    // validate allowed rules\r\n    eventBus.on('dragAndDrop.dragEnter', (event) => {\r\n\r\n      const {\r\n        dragContext\r\n      } = event;\r\n\r\n      const {\r\n        draggedElement,\r\n        hoverEl\r\n      } = dragContext;\r\n\r\n      // can always drag rows\r\n      if (draggedElement instanceof Row) {\r\n        return true;\r\n      }\r\n\r\n      if (draggedElement instanceof Col) {\r\n        const dropIndex = getTargetColIndex(hoverEl, this._elementRegistry, this._sheet);\r\n\r\n        // cannot drop as we cannot compute the drop index\r\n        if (dropIndex === -1) {\r\n          return false;\r\n        }\r\n\r\n        const allowed = this._rules.allowed('col.move', {\r\n          col: draggedElement,\r\n          index: dropIndex\r\n        });\r\n\r\n        return allowed;\r\n      }\r\n\r\n      return false;\r\n    });\r\n\r\n    // clear previous UI\r\n    eventBus.on('dragAndDrop.dragLeave', (event) => {\r\n\r\n      const {\r\n        dragContext\r\n      } = event;\r\n\r\n      const {\r\n        targetEl\r\n      } = dragContext;\r\n\r\n      if (!targetEl) {\r\n        return;\r\n      }\r\n\r\n      const container = this._renderer.getContainer();\r\n\r\n      removeHighlight(container);\r\n    });\r\n\r\n    // update UI\r\n    eventBus.on('dragAndDrop.dragOver', (event) => {\r\n\r\n      const {\r\n        dragContext,\r\n        originalEvent\r\n      } = event;\r\n\r\n      const {\r\n        draggedElement,\r\n        lastPosition,\r\n        targetEl\r\n      } = dragContext;\r\n\r\n      const container = this._renderer.getContainer();\r\n\r\n      if (!targetEl) {\r\n        return false;\r\n      }\r\n\r\n      let newPosition;\r\n\r\n      if (draggedElement instanceof Row) {\r\n        newPosition = getVerticalPosition(\r\n          originalEvent,\r\n          targetEl\r\n        );\r\n      }\r\n\r\n      if (draggedElement instanceof Col) {\r\n        newPosition = getHorizontalPosition(\r\n          originalEvent,\r\n          targetEl\r\n        );\r\n      }\r\n\r\n      // nothing to do\r\n      if (lastPosition === newPosition) {\r\n        return true;\r\n      }\r\n\r\n      // remove old highlight\r\n      removeHighlight(container);\r\n\r\n      if (draggedElement instanceof Row) {\r\n\r\n        if (newPosition === TOP) {\r\n\r\n          // drop above\r\n          highlightRow(targetEl, container, 'top');\r\n        } else {\r\n\r\n          // drop below\r\n          highlightRow(targetEl, container, 'bottom');\r\n        }\r\n      }\r\n\r\n      if (draggedElement instanceof Col) {\r\n        if (newPosition === LEFT) {\r\n\r\n          // drop left\r\n          highlightCol(targetEl, container, 'left');\r\n        } else {\r\n\r\n          // drop right\r\n          highlightCol(targetEl, container, 'right');\r\n        }\r\n      }\r\n\r\n      // remember position\r\n      dragContext.lastPosition = newPosition;\r\n\r\n      // allowed\r\n      return true;\r\n    });\r\n\r\n\r\n    // perform drop operation\r\n    eventBus.on('dragAndDrop.drop', (event) => {\r\n\r\n      const {\r\n        dragContext,\r\n        originalEvent\r\n      } = event;\r\n\r\n      const {\r\n        draggedElement,\r\n        targetEl\r\n      } = dragContext;\r\n\r\n      if (!targetEl) {\r\n        return false;\r\n      }\r\n\r\n      if (draggedElement instanceof Row) {\r\n        const verticalPosition = getVerticalPosition(\r\n          originalEvent,\r\n          targetEl\r\n        );\r\n\r\n        const rowId = targetEl.dataset.rowId,\r\n              row = this._elementRegistry.get(rowId);\r\n\r\n        if (!row || row === draggedElement) {\r\n          return;\r\n        }\r\n\r\n        const targetRow = getTargetRow(\r\n          draggedElement,\r\n          row,\r\n          verticalPosition,\r\n          this._sheet.getRoot().rows\r\n        );\r\n\r\n        if (targetRow === draggedElement) {\r\n          return;\r\n        }\r\n\r\n        return targetRow;\r\n      }\r\n\r\n      if (draggedElement instanceof Col) {\r\n        const horizontalPosition = getHorizontalPosition(\r\n          originalEvent,\r\n          targetEl\r\n        );\r\n\r\n        // no need to check rules; we verified on\r\n        // dragEnter that dropping is O.K.\r\n        const colId = targetEl.dataset.colId,\r\n              col = this._elementRegistry.get(colId);\r\n\r\n        if (!col || col === draggedElement) {\r\n          return;\r\n        }\r\n\r\n        const targetCol = getTargetCol(\r\n          draggedElement,\r\n          col,\r\n          horizontalPosition,\r\n          this._sheet.getRoot().cols\r\n        );\r\n\r\n        if (targetCol === draggedElement) {\r\n          return;\r\n        }\r\n\r\n        return targetCol;\r\n      }\r\n    });\r\n\r\n    eventBus.on('dragAndDrop.dragEnd', this._cleanup);\r\n  }\r\n\r\n  startDrag(element, event) {\r\n    const container = this._renderer.getContainer();\r\n\r\n    this._dragImage = domify(\r\n      `<span style=\"\r\n          visibility: hidden;\r\n          position: fixed;\r\n          top: -10000px\r\n      \"></span>`\r\n    );\r\n\r\n    // needs to be present in DOM\r\n    document.body.appendChild(this._dragImage);\r\n\r\n    // QUIRK: not supported by Edge and Internet Explorer\r\n    if (event.dataTransfer.setDragImage) {\r\n      event.dataTransfer.setDragImage(this._dragImage, 0, 0);\r\n    }\r\n\r\n    if (element instanceof Row) {\r\n      fadeOutRow(element, container);\r\n    } else if (element instanceof Col) {\r\n      fadeOutCol(element, container);\r\n    }\r\n\r\n    this._dragAndDrop.startDrag(element, event);\r\n  }\r\n\r\n  _cleanup = () => {\r\n    const container = this._renderer.getContainer();\r\n\r\n    removeHighlight(container);\r\n    removeFadeOut(container);\r\n\r\n    if (this._dragImage) {\r\n      domRemove(this._dragImage);\r\n\r\n      this._dragImage = null;\r\n    }\r\n  };\r\n\r\n}\r\n\r\nDragAndDrop.$inject = [\r\n  'components',\r\n  'elementRegistry',\r\n  'eventBus',\r\n  'dragAndDrop',\r\n  'renderer',\r\n  'rules',\r\n  'sheet'\r\n];\r\n\r\n// helpers //////////\r\n\r\nfunction getTargetColIndex(cellEl, elementRegistry, sheet) {\r\n  const targetCol = elementRegistry.get(cellEl.dataset.colId);\r\n\r\n  if (!targetCol) {\r\n    return -1;\r\n  }\r\n\r\n  const { cols } = sheet.getRoot();\r\n\r\n  return cols.indexOf(targetCol);\r\n}\r\n\r\nfunction highlightRow(dragOverCell, container, position) {\r\n  const rowId = dragOverCell.dataset.rowId;\r\n\r\n  if (!rowId) {\r\n    return;\r\n  }\r\n\r\n  const cells = domQueryAll(`[data-row-id=${rowId}]`, container);\r\n\r\n  forEach(cells, cell => {\r\n\r\n    // QUIRK: PhantomJS might return object instead of NodeList\r\n    if (isNode(cell)) {\r\n      domClasses(cell).add('dragover');\r\n      domClasses(cell).add(position);\r\n    }\r\n  });\r\n}\r\n\r\nfunction highlightCol(dragOverCell, container, position) {\r\n  const colId = dragOverCell.dataset.colId;\r\n\r\n  if (!colId) {\r\n    return;\r\n  }\r\n\r\n  const cells = domQueryAll(`[data-col-id=${colId}]`, container);\r\n\r\n  forEach(cells, cell => {\r\n\r\n    // QUIRK: PhantomJS might return object instead of NodeList\r\n    if (isNode(cell)) {\r\n      domClasses(cell).add('dragover');\r\n      domClasses(cell).add(position);\r\n    }\r\n  });\r\n}\r\n\r\nfunction removeHighlight(container) {\r\n  const cells = domQueryAll('.dragover', container);\r\n\r\n  forEach(cells, cell => {\r\n\r\n    // QUIRK: PhantomJS might return object instead of NodeList\r\n    if (isNode(cell)) {\r\n      domClasses(cell).remove('dragover');\r\n      domClasses(cell).remove('top');\r\n      domClasses(cell).remove('right');\r\n      domClasses(cell).remove('bottom');\r\n      domClasses(cell).remove('left');\r\n    }\r\n  });\r\n}\r\n\r\nfunction fadeOutRow(row, container) {\r\n  const cells = domQueryAll(`[data-row-id=${row.id}]`, container);\r\n\r\n  forEach(cells, cell => {\r\n\r\n    // QUIRK: PhantomJS might return object instead of NodeList\r\n    if (isNode(cell)) {\r\n      domClasses(cell).add('dragged');\r\n    }\r\n  });\r\n}\r\n\r\nfunction fadeOutCol(col, container) {\r\n  const cells = domQueryAll(`[data-col-id=${col.id}]`, container);\r\n\r\n  forEach(cells, cell => {\r\n\r\n    // QUIRK: PhantomJS might return object instead of NodeList\r\n    if (isNode(cell)) {\r\n      domClasses(cell).add('dragged');\r\n    }\r\n  });\r\n}\r\n\r\nfunction removeFadeOut(container) {\r\n  const cells = domQueryAll('.dragged', container);\r\n\r\n  forEach(cells, cell => {\r\n\r\n    // QUIRK: PhantomJS might return object instead of NodeList\r\n    if (isNode(cell)) {\r\n      domClasses(cell).remove('dragged');\r\n    }\r\n  });\r\n}\r\n\r\nfunction getHorizontalPosition(event, dragOverElement) {\r\n  const bounds = dragOverElement.getBoundingClientRect();\r\n\r\n  return event.clientX < (bounds.left + bounds.width / 2)\r\n    ? LEFT\r\n    : RIGHT;\r\n}\r\n\r\nfunction getVerticalPosition(event, dragOverElement) {\r\n  const bounds = dragOverElement.getBoundingClientRect();\r\n\r\n  return event.clientY < (bounds.top + bounds.height / 2)\r\n    ? TOP\r\n    : BOTTOM;\r\n}\r\n\r\nfunction getTargetRow(draggedRow, targetRow, verticalPosition, rows) {\r\n  if (rows.indexOf(draggedRow) > rows.indexOf(targetRow)) {\r\n    targetRow = getRowBelow(targetRow, rows);\r\n  }\r\n\r\n  if (verticalPosition === TOP) {\r\n\r\n    // return row above or row\r\n    return getRowAbove(targetRow, rows);\r\n  } else {\r\n\r\n    // return row\r\n    return targetRow;\r\n  }\r\n}\r\n\r\nfunction getTargetCol(draggedCol, targetCol, horizontalPosition, cols) {\r\n  if (cols.indexOf(draggedCol) > cols.indexOf(targetCol)) {\r\n    targetCol = getColRight(targetCol, cols);\r\n  }\r\n\r\n  if (horizontalPosition === LEFT) {\r\n\r\n    // return col left or col\r\n    return getColLeft(targetCol, cols);\r\n  } else {\r\n\r\n    // return col\r\n    return targetCol;\r\n  }\r\n}\r\n\r\nfunction getRowAbove(row, rows) {\r\n  const index = rows.indexOf(row);\r\n\r\n  return rows[ Math.max(0, index - 1) ];\r\n}\r\n\r\nfunction getRowBelow(row, rows) {\r\n  const index = rows.indexOf(row);\r\n\r\n  return rows[ Math.min(rows.length - 1, index + 1) ];\r\n}\r\n\r\nfunction getColLeft(col, cols) {\r\n  const index = cols.indexOf(col);\r\n\r\n  if (isOutput(col)) {\r\n    const firstOutput = cols.filter(col => isOutput(col))[0];\r\n\r\n    const firstOutputIndex = cols.indexOf(firstOutput);\r\n\r\n    return cols[ Math.max(firstOutputIndex, index - 1) ];\r\n  }\r\n\r\n  return cols[ Math.max(0, index - 1) ];\r\n}\r\n\r\nfunction getColRight(col, cols) {\r\n  const index = cols.indexOf(col);\r\n\r\n  if (isInput(col)) {\r\n    const inputs = cols.filter(col => isInput(col));\r\n\r\n    const lastInput = inputs[ inputs.length - 1 ];\r\n\r\n    const lastInputIndex = cols.indexOf(lastInput);\r\n\r\n    return cols[ Math.min(lastInputIndex, index + 1) ];\r\n  }\r\n\r\n  return cols[ Math.min(cols.length - 1, index + 1) ];\r\n}\r\n\r\n// QUIRK: PhantomJS requires check if actual DOM node\r\nfunction isNode(node) {\r\n  return node && (node.nodeType === 1 || node.nodeType == 11);\r\n}"],"mappings":"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"}
{"version":3,"file":"DrdTreeWalker.js","names":["forEach","Refs","is","diRefs","name","enumerable","configurable","DRDTreeWalker","handler","options","deferred","visit","element","gfx","Error","id","visitRoot","root","visitIfDi","di","e","logError","message","error","handleDefinitions","definitions","diagram","dmnDI","diagrams","indexOf","length","handleDiagram","handleDrgElements","get","handleArtifacts","handleDeferred","elements","handleRequirements","handleAssociation","defer","requirements","requirement","diagramElements","handleDiagramElement","diagramElement","registerDi","dmnElement","dmnElementRef","bind","fn","push","d","context"],"sources":["../../src/import/DrdTreeWalker.js"],"sourcesContent":["import {\n  forEach\n} from 'min-dash';\n\nimport Refs from 'object-refs';\n\nimport { is } from 'dmn-js-shared/lib/util/ModelUtil';\n\n\nvar diRefs = new Refs(\n  { name: 'dmnElementRef', enumerable: true },\n  { name: 'di', configurable: true }\n);\n\nexport default function DRDTreeWalker(handler, options) {\n\n  // list of elements to handle deferred to ensure\n  // prerequisites are drawn\n  var deferred = [];\n\n  function visit(element) {\n\n    var gfx = element.gfx;\n\n    // avoid multiple rendering of elements\n    if (gfx) {\n      throw new Error('already rendered ' + element.id);\n    }\n\n    // call handler\n    return handler.element(element);\n  }\n\n  function visitRoot(element) {\n    return handler.root(element);\n  }\n\n  function visitIfDi(element) {\n\n    try {\n      var gfx = element.di && visit(element);\n\n      return gfx;\n    } catch (e) {\n      logError(e.message, { element: element, error: e });\n    }\n  }\n\n\n  // Semantic handling //////////////////////\n\n  /**\n   * Handle definitions and return the rendered diagram (if any)\n   *\n   * @param {ModdleElement} definitions to walk and import\n   * @param {ModdleElement} [diagram] specific diagram to import and display\n   *\n   * @throws {Error} if no diagram to display could be found\n   */\n  function handleDefinitions(definitions, diagram) {\n\n    // make sure we walk the correct dmnElement\n    var dmnDI = definitions.dmnDI;\n\n    if (!dmnDI) {\n      throw new Error('no dmndi:DMNDI');\n    }\n\n    var diagrams = dmnDI.diagrams || [];\n\n    if (diagram && diagrams.indexOf(diagram) === -1) {\n      throw new Error('diagram not part of dmndi:DMNDI');\n    }\n\n    if (!diagram && diagrams && diagrams.length) {\n      diagram = diagrams[0];\n    }\n\n    // no diagram -> nothing to import\n    if (!diagram) {\n      throw new Error('no diagram to display');\n    }\n\n    // assign current diagram to definitions so that it can accessed later\n    definitions.di = diagram;\n\n    // load DI from selected diagram only\n    handleDiagram(diagram);\n\n    visitRoot(definitions);\n\n    handleDrgElements(definitions.get('drgElement'));\n    handleArtifacts(definitions.get('artifact'));\n\n    handleDeferred();\n  }\n\n  function handleDrgElements(elements) {\n    forEach(elements, function(element) {\n      visitIfDi(element);\n\n      handleRequirements(element);\n    });\n  }\n\n  function handleArtifacts(elements) {\n    forEach(elements, function(element) {\n      if (is(element, 'dmn:Association')) {\n        handleAssociation(element);\n      } else {\n        visitIfDi(element);\n      }\n    });\n  }\n\n  /**\n   * Defer association visit until all shapes are visited.\n   *\n   * @param {ModdleElement} element\n   */\n  function handleAssociation(element) {\n    defer(function() {\n      visitIfDi(element);\n    });\n  }\n\n  /**\n   * Defer requirements visiting until all shapes are visited.\n   *\n   * @param {ModdleElement} element\n   */\n  function handleRequirements(element) {\n    forEach([\n      'informationRequirement',\n      'knowledgeRequirement',\n      'authorityRequirement'\n    ], function(requirements) {\n      forEach(element[requirements], function(requirement) {\n        defer(function() {\n          visitIfDi(requirement);\n        });\n      });\n    });\n  }\n\n  // DI handling //////////////////////\n  function handleDiagram(diagram) {\n    forEach(diagram.diagramElements, handleDiagramElement);\n  }\n\n  function handleDiagramElement(diagramElement) {\n    registerDi(diagramElement);\n  }\n\n  function registerDi(di) {\n    var dmnElement = di.dmnElementRef;\n\n    if (dmnElement) {\n      if (dmnElement.di) {\n        logError('multiple DI elements defined for element', { element: dmnElement });\n      } else {\n        diRefs.bind(dmnElement, 'di');\n        dmnElement.di = di;\n      }\n    } else {\n      logError('no DMN element referenced in element', { element: di });\n    }\n  }\n\n  function defer(fn) {\n    deferred.push(fn);\n  }\n\n  function handleDeferred() {\n    forEach(deferred, function(d) {\n      d();\n    });\n  }\n\n  function logError(message, context) {\n    handler.error(message, context);\n  }\n\n  // API //////////////////////\n\n  return {\n    handleDefinitions: handleDefinitions\n  };\n}\n"],"mappings":"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"}
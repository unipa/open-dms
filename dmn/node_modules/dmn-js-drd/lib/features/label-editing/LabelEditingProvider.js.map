{"version":3,"file":"LabelEditingProvider.js","names":["getLabel","is","assign","isDefined","LabelEditingProvider","canvas","directEditing","eventBus","modeling","textRenderer","_canvas","_modeling","_textRenderer","registerProvider","on","event","activate","element","complete","cancel","e","shape","$inject","prototype","text","context","editingBBox","getEditingBBox","options","centerVertically","resizable","target","label","bbox","getAbsoluteBBox","bounds","x","y","zoom","defaultStyle","getDefaultStyle","defaultFontSize","fontSize","defaultLineHeight","lineHeight","style","fontFamily","fontWeight","width","height","paddingTop","paddingBottom","paddingLeft","paddingRight","minWidth","minHeight","textAlign","update","newLabel","activeContextText","newBounds","isEmptyText","updateLabel","trim"],"sources":["../../../src/features/label-editing/LabelEditingProvider.js"],"sourcesContent":["import { getLabel } from './LabelUtil';\n\nimport {\n  is\n} from 'dmn-js-shared/lib/util/ModelUtil';\n\nimport {\n  assign,\n  isDefined\n} from 'min-dash';\n\n\nexport default function LabelEditingProvider(\n    canvas,\n    directEditing,\n    eventBus,\n    modeling,\n    textRenderer\n) {\n\n  this._canvas = canvas;\n  this._modeling = modeling;\n  this._textRenderer = textRenderer;\n\n  directEditing.registerProvider(this);\n\n  // listen to dblclick on non-root elements\n  eventBus.on('element.dblclick', function(event) {\n    directEditing.activate(event.element);\n  });\n\n  // complete on followup canvas operation\n  eventBus.on([\n    'autoPlace.start',\n    'canvas.viewbox.changing',\n    'drag.init',\n    'drillDown.click',\n    'element.mousedown',\n    'popupMenu.open',\n    'selection.changed'\n  ], function() {\n    directEditing.complete();\n  });\n\n  // cancel on command stack changes\n  eventBus.on([ 'commandStack.changed' ], function() {\n    directEditing.cancel();\n  });\n\n  eventBus.on('create.end', 500, function(e) {\n\n    var element = e.shape;\n\n    if (\n      is(element, 'dmn:Decision') ||\n      is(element, 'dmn:InputData') ||\n      is(element, 'dmn:BusinessKnowledgeModel') ||\n      is(element, 'dmn:KnowledgeSource') ||\n      is(element, 'dmn:TextAnnotation')\n    ) {\n      directEditing.activate(element);\n    }\n  });\n\n  eventBus.on('autoPlace.end', 500, function(event) {\n    directEditing.activate(event.shape);\n  });\n}\n\nLabelEditingProvider.$inject = [\n  'canvas',\n  'directEditing',\n  'eventBus',\n  'modeling',\n  'textRenderer'\n];\n\n\n/**\n * Activate direct editing for drgs and text annotations.\n *\n * @param  {djs.model.Base} element\n *\n * @return {Object} an object with properties bounds (position and size) and text\n */\nLabelEditingProvider.prototype.activate = function(element) {\n\n  var text = getLabel(element);\n\n  if (!isDefined(text)) {\n    return;\n  }\n\n  var context = {\n    text: text\n  };\n\n  var editingBBox = this.getEditingBBox(element);\n\n  assign(context, editingBBox);\n\n  var options = {};\n\n  // DRG elements\n  if (is(element, 'dmn:DRGElement')) {\n    assign(options, {\n      centerVertically: true\n    });\n  }\n\n  // text annotations\n  if (is(element, 'dmn:TextAnnotation')) {\n    assign(options, {\n      resizable: true\n    });\n  }\n\n  assign(context, {\n    options: options\n  });\n\n  return context;\n};\n\n\n/**\n * Get the editing bounding box based on the element's size and position\n *\n * @param  {djs.model.Base} element\n *\n * @return {Object}\n *         an object containing information about position and\n *         size (fixed or minimum and/or maximum)\n */\nLabelEditingProvider.prototype.getEditingBBox = function(element) {\n  var canvas = this._canvas;\n\n  var target = element.label || element;\n\n  var bbox = canvas.getAbsoluteBBox(target);\n\n  // default position\n  var bounds = { x: bbox.x, y: bbox.y };\n\n  var zoom = canvas.zoom();\n\n  var defaultStyle = this._textRenderer.getDefaultStyle();\n\n  // take zoom into account\n  var defaultFontSize = defaultStyle.fontSize * zoom,\n      defaultLineHeight = defaultStyle.lineHeight;\n\n  var style = {\n    fontFamily: this._textRenderer.getDefaultStyle().fontFamily,\n    fontWeight: this._textRenderer.getDefaultStyle().fontWeight\n  };\n\n  // DRG elements\n  if (is(element, 'dmn:DRGElement')) {\n    assign(bounds, {\n      width: bbox.width,\n      height: bbox.height\n    });\n\n    assign(style, {\n      fontSize: defaultFontSize + 'px',\n      lineHeight: defaultLineHeight,\n      paddingTop: (7 * zoom) + 'px',\n      paddingBottom: (7 * zoom) + 'px',\n      paddingLeft: (5 * zoom) + 'px',\n      paddingRight: (5 * zoom) + 'px'\n    });\n  }\n\n  // text annotations\n  if (is(element, 'dmn:TextAnnotation')) {\n    assign(bounds, {\n      width: bbox.width,\n      height: bbox.height,\n      minWidth: 30 * zoom,\n      minHeight: 10 * zoom\n    });\n\n    assign(style, {\n      textAlign: 'left',\n      paddingTop: (5 * zoom) + 'px',\n      paddingBottom: (7 * zoom) + 'px',\n      paddingLeft: (7 * zoom) + 'px',\n      paddingRight: (5 * zoom) + 'px',\n      fontSize: defaultFontSize + 'px',\n      lineHeight: defaultLineHeight\n    });\n  }\n\n  return { bounds: bounds, style: style };\n};\n\n\nLabelEditingProvider.prototype.update = function(\n    element,\n    newLabel,\n    activeContextText,\n    bounds\n) {\n  var newBounds,\n      bbox;\n\n  if (is(element, 'dmn:TextAnnotation')) {\n\n    bbox = this._canvas.getAbsoluteBBox(element);\n\n    newBounds = {\n      x: element.x,\n      y: element.y,\n      width: element.width / bbox.width * bounds.width,\n      height: element.height / bbox.height * bounds.height\n    };\n  }\n\n  if (isEmptyText(newLabel)) {\n    newLabel = null;\n  }\n\n  this._modeling.updateLabel(element, newLabel, newBounds);\n};\n\n// helpers //////////\n\nfunction isEmptyText(label) {\n  return !label || !label.trim();\n}"],"mappings":"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"}
{"version":3,"file":"ContextPadProvider.js","names":["assign","isArray","is","isAny","hasPrimaryModifier","ContextPadProvider","eventBus","contextPad","modeling","elementFactory","connect","create","rules","popupMenu","canvas","translate","config","injector","registerProvider","_contextPad","_modeling","_elementFactory","_connect","_create","_rules","_popupMenu","_canvas","_translate","autoPlace","_autoPlace","get","on","event","shape","context","entries","getEntries","replace","action","click","$inject","prototype","getContextPadEntries","element","actions","type","businessObject","startConnect","autoActivate","start","removeElement","e","removeElements","getReplaceMenuPosition","Y_OFFSET","diagramContainer","getContainer","pad","getPad","html","diagramRect","getBoundingClientRect","padRect","top","left","pos","x","y","height","appendAction","className","title","options","appendStart","createShape","source","hints","connectionTarget","append","group","dragstart","isEmpty","position","cursor","open","deleteAllowed","allowed","elements"],"sources":["../../../src/features/context-pad/ContextPadProvider.js"],"sourcesContent":["import {\n  assign,\n  isArray\n} from 'min-dash';\n\nimport {\n  is,\n  isAny\n} from 'dmn-js-shared/lib/util/ModelUtil';\n\nimport {\n  hasPrimaryModifier\n} from 'diagram-js/lib/util/Mouse';\n\n\n/**\n* A provider for DMN elements context pad\n*/\nexport default function ContextPadProvider(\n    eventBus, contextPad, modeling,\n    elementFactory, connect, create,\n    rules, popupMenu, canvas,\n    translate, config, injector) {\n\n  config = config || {};\n\n  contextPad.registerProvider(this);\n\n  this._contextPad = contextPad;\n\n  this._modeling = modeling;\n\n  this._elementFactory = elementFactory;\n  this._connect = connect;\n  this._create = create;\n  this._rules = rules;\n  this._popupMenu = popupMenu;\n  this._canvas = canvas;\n  this._translate = translate;\n\n  if (config.autoPlace !== false) {\n    this._autoPlace = injector.get('autoPlace', false);\n  }\n\n\n  eventBus.on('create.end', 250, function(event) {\n    var shape = event.context.shape;\n\n    if (!hasPrimaryModifier(event)) {\n      return;\n    }\n\n    var entries = contextPad.getEntries(shape);\n\n    if (entries.replace) {\n      entries.replace.action.click(event, shape);\n    }\n  });\n}\n\nContextPadProvider.$inject = [\n  'eventBus',\n  'contextPad',\n  'modeling',\n  'elementFactory',\n  'connect',\n  'create',\n  'rules',\n  'popupMenu',\n  'canvas',\n  'translate',\n  'config.contextPad',\n  'injector'\n];\n\n\nContextPadProvider.prototype.getContextPadEntries = function(element) {\n\n  var modeling = this._modeling,\n\n      elementFactory = this._elementFactory,\n      connect = this._connect,\n      create = this._create,\n      popupMenu = this._popupMenu,\n      canvas = this._canvas,\n      contextPad = this._contextPad,\n      rules = this._rules,\n      translate = this._translate,\n      autoPlace = this._autoPlace;\n\n  var actions = {};\n\n  if (element.type === 'label') {\n    return actions;\n  }\n\n  var businessObject = element.businessObject;\n\n  function startConnect(event, element, autoActivate) {\n    connect.start(event, element, autoActivate);\n  }\n\n  function removeElement(e) {\n    modeling.removeElements([ element ]);\n  }\n\n  function getReplaceMenuPosition(element) {\n\n    var Y_OFFSET = 5;\n\n    var diagramContainer = canvas.getContainer(),\n        pad = contextPad.getPad(element).html;\n\n    var diagramRect = diagramContainer.getBoundingClientRect(),\n        padRect = pad.getBoundingClientRect();\n\n    var top = padRect.top - diagramRect.top;\n    var left = padRect.left - diagramRect.left;\n\n    var pos = {\n      x: left,\n      y: top + padRect.height + Y_OFFSET\n    };\n\n    return pos;\n  }\n\n  /**\n  * Create an append action\n  *\n  * @param {string} type\n  * @param {string} className\n  * @param {string} [title]\n  * @param {Object} [options]\n  *\n  * @return {Object} descriptor\n  */\n  function appendAction(type, className, title, options) {\n\n    if (typeof title !== 'string') {\n      options = title;\n      title = translate('Append {type}', { type: type.replace(/^dmn:/, '') });\n    }\n\n    function appendStart(event, element) {\n\n      var shape = elementFactory.createShape(assign({ type: type }, options));\n\n      create.start(event, shape, {\n        source: element,\n        hints: {\n          connectionTarget: element\n        }\n      });\n    }\n\n    var append = autoPlace ? function(event, element) {\n      var shape = elementFactory.createShape(assign({ type: type }, options));\n\n      autoPlace.append(element, shape, {\n        connectionTarget: element\n      });\n    } : appendStart;\n\n    return {\n      group: 'model',\n      className: className,\n      title: title,\n      action: {\n        dragstart: appendStart,\n        click: append\n      }\n    };\n  }\n\n  if (is(businessObject, 'dmn:Decision')) {\n    assign(actions, {\n      'append.decision': appendAction('dmn:Decision', 'dmn-icon-decision')\n    });\n  }\n\n  if (\n    isAny(businessObject, [\n      'dmn:BusinessKnowledgeModel',\n      'dmn:Decision',\n      'dmn:KnowledgeSource'\n    ])\n  ) {\n    assign(actions, {\n      'append.knowledge-source': appendAction(\n        'dmn:KnowledgeSource',\n        'dmn-icon-knowledge-source'\n      )\n    });\n  }\n\n  if (isAny(businessObject, [\n    'dmn:BusinessKnowledgeModel',\n    'dmn:Decision'\n  ])) {\n    assign(actions, {\n      'append.business-knowledge-model': appendAction(\n        'dmn:BusinessKnowledgeModel',\n        'dmn-icon-business-knowledge'\n      )\n    });\n  }\n\n  if (isAny(businessObject, [ 'dmn:Decision', 'dmn:KnowledgeSource' ])) {\n    assign(actions, {\n      'append.input-data': appendAction('dmn:InputData', 'dmn-icon-input-data')\n    });\n  }\n\n  if (is(businessObject, 'dmn:DRGElement')) {\n\n    assign(actions, {\n      'append.text-annotation': appendAction(\n        'dmn:TextAnnotation',\n        'dmn-icon-text-annotation'\n      ),\n\n      'connect': {\n        group: 'connect',\n        className: 'dmn-icon-connection-multi',\n        title: translate(\n          'Connect using Information/Knowledge' +\n          '/Authority Requirement or Association'\n        ),\n        action: {\n          click: startConnect,\n          dragstart: startConnect\n        }\n      }\n    });\n  }\n\n  if (is(businessObject, 'dmn:TextAnnotation')) {\n    assign(actions, {\n      'connect': {\n        group: 'connect',\n        className: 'dmn-icon-connection-multi',\n        title: translate(\n          'Connect using association'\n        ),\n        action: {\n          click: startConnect,\n          dragstart: startConnect\n        }\n      }\n    });\n  }\n\n  if (!popupMenu.isEmpty(element, 'dmn-replace')) {\n\n    // Replace menu entry\n    assign(actions, {\n      'replace': {\n        group: 'edit',\n        className: 'dmn-icon-screw-wrench',\n        title: translate('Change type'),\n        action: {\n          click: function(event, element) {\n\n            var position = assign(getReplaceMenuPosition(element), {\n              cursor: { x: event.x, y: event.y }\n            });\n\n            popupMenu.open(element, 'dmn-replace', position);\n          }\n        }\n      }\n    });\n  }\n\n\n  // delete element entry, only show if allowed by rules\n  var deleteAllowed = rules.allowed('elements.delete', { elements: [ element ] });\n\n  if (isArray(deleteAllowed)) {\n\n    // was the element returned as a deletion candidate?\n    deleteAllowed = deleteAllowed[0] === element;\n  }\n\n  if (deleteAllowed) {\n    assign(actions, {\n      'delete': {\n        group: 'edit',\n        className: 'dmn-icon-trash',\n        title: translate('Remove'),\n        action: {\n          click: removeElement\n        }\n      }\n    });\n  }\n\n  return actions;\n};\n"],"mappings":"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"}
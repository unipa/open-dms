{"version":3,"file":"DragAndDrop.js","names":["Row","Col","closest","domClosest","event","domEvent","TARGET_SELECTOR","DragAndDrop","constructor","eventBus","renderer","modeling","sheet","stopEvent","targetEl","target","cellEl","allowed","hoverEl","_dragContext","_emit","dataTransfer","dropEffect","draggedElement","rows","_sheet","getRoot","index","indexOf","_modeling","moveRow","cols","moveCol","handleDragEnd","_unbindListeners","_eventBus","_renderer","on","_bindListeners","bind","document","handleDragOver","handleDrop","unbind","eventName","originalEvent","fire","dragContext","startDrag","element","effectAllowed","setData","$inject","preventDefault","stopPropagation"],"sources":["../../../src/features/drag-and-drop/DragAndDrop.js"],"sourcesContent":["import { Row, Col } from '../../model';\r\n\r\nimport {\r\n  closest as domClosest,\r\n  event as domEvent\r\n} from 'min-dom';\r\n\r\nconst TARGET_SELECTOR =\r\n  `.dmn-decision-table-container td,\r\n   .dmn-decision-table-container th`;\r\n\r\nexport default class DragAndDrop {\r\n  constructor(eventBus, renderer, modeling, sheet) {\r\n    this._eventBus = eventBus;\r\n    this._renderer = renderer;\r\n    this._modeling = modeling;\r\n    this._sheet = sheet;\r\n\r\n    this._dragContext = null;\r\n\r\n    eventBus.on('table.destroy', () => {\r\n      this._unbindListeners();\r\n    });\r\n  }\r\n\r\n  _bindListeners() {\r\n    domEvent.bind(document, 'dragover', this.handleDragOver);\r\n    domEvent.bind(document, 'drop', this.handleDrop);\r\n    domEvent.bind(document, 'dragend', this.handleDragEnd);\r\n  }\r\n\r\n  _unbindListeners() {\r\n    domEvent.unbind(document, 'dragover', this.handleDragOver);\r\n    domEvent.unbind(document, 'drop', this.handleDrop);\r\n    domEvent.unbind(document, 'dragend', this.handleDragEnd);\r\n  }\r\n\r\n  _emit(eventName, originalEvent) {\r\n\r\n    return this._eventBus.fire(eventName, {\r\n      dragContext: this._dragContext,\r\n      originalEvent\r\n    });\r\n  }\r\n\r\n  startDrag(element, event) {\r\n\r\n    stopEvent(event, true);\r\n\r\n    event.dataTransfer.effectAllowed = 'move';\r\n\r\n    // QUIRK: Firefox won't fire events unless data was set\r\n    if (event.dataTransfer.setData) {\r\n      event.dataTransfer.setData('text', '__DUMMY');\r\n    }\r\n\r\n    this._dragContext = {\r\n      draggedElement: element\r\n    };\r\n\r\n    this._bindListeners();\r\n\r\n    this._emit('dragAndDrop.dragStart', event);\r\n  }\r\n\r\n  handleDragOver = (event) => {\r\n\r\n    // we're taking over (!)\r\n    stopEvent(event);\r\n\r\n    const targetEl = event.target;\r\n\r\n    const cellEl = domClosest(targetEl, TARGET_SELECTOR, true);\r\n\r\n    let allowed = !!cellEl;\r\n\r\n    const {\r\n      hoverEl\r\n    } = this._dragContext;\r\n\r\n    // drag leave\r\n    if (hoverEl && hoverEl !== cellEl) {\r\n      this._emit('dragAndDrop.dragLeave', event);\r\n\r\n      // unset target element\r\n      this._dragContext.targetEl = null;\r\n\r\n      // unset hover element\r\n      this._dragContext.hoverEl = null;\r\n    }\r\n\r\n    if (cellEl) {\r\n\r\n      // drag enter\r\n      if (cellEl !== hoverEl) {\r\n\r\n        // new hover element\r\n        this._dragContext.hoverEl = cellEl;\r\n\r\n        allowed = this._emit('dragAndDrop.dragEnter', event);\r\n\r\n        if (allowed !== false) {\r\n\n          // new targetEl\r\n          this._dragContext.targetEl = cellEl;\r\n        }\r\n      }\r\n\r\n      // drag over\r\n      allowed = this._emit('dragAndDrop.dragOver', event);\r\n    }\r\n\r\n    event.dataTransfer.dropEffect = allowed !== false ? 'move' : 'none';\r\n  };\r\n\r\n  handleDrop = (event) => {\r\n\r\n    // prevent default drop action\r\n    // QUIRK: Firefox will redirect if not prevented\r\n    stopEvent(event);\r\n\r\n    const target = this._emit('dragAndDrop.drop', event);\r\n\r\n    if (target) {\r\n\r\n      const {\r\n        draggedElement\r\n      } = this._dragContext;\r\n\r\n      if (draggedElement instanceof Row) {\r\n        const { rows } = this._sheet.getRoot();\r\n\r\n        let index = rows.indexOf(target);\r\n\r\n        this._modeling.moveRow(draggedElement, index);\r\n      } else if (draggedElement instanceof Col) {\r\n        const { cols } = this._sheet.getRoot();\r\n\r\n        let index = cols.indexOf(target);\r\n\r\n        this._modeling.moveCol(draggedElement, index);\r\n      }\r\n    }\r\n\r\n    // manually call to drag end needed, as we prevent the default\r\n    // browser behavior / drag end handling via\r\n    // event.preventDefault();\r\n    this.handleDragEnd(event);\r\n  };\r\n\r\n  handleDragEnd = (event) => {\r\n\r\n    // prevent default drop action\r\n    stopEvent(event);\r\n\r\n    this._unbindListeners();\r\n    this._emit('dragAndDrop.dragEnd', event);\r\n\r\n    this._dragContext = null;\r\n  };\r\n\r\n}\r\n\r\nDragAndDrop.$inject = [\r\n  'eventBus',\r\n  'renderer',\r\n  'modeling',\r\n  'sheet'\r\n];\r\n\r\n\r\n\r\n// helpers /////////////////\r\n\r\nfunction stopEvent(event, preventDefault) {\r\n  event.stopPropagation();\r\n\r\n  if (preventDefault !== true) {\r\n    event.preventDefault();\r\n  }\r\n}"],"mappings":"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"}
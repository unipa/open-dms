{"version":3,"file":"ChangeSupport.js","names":["ChangeSupport","constructor","eventBus","_listeners","on","elements","elementsChanged","context","oldRootId","root","id","once","newRootId","updateId","element","newId","invoked","elementsLength","length","i","listenersLength","j","onElementsChanged","listener","offElementsChanged","idx","indexOf","splice","oldId","$inject"],"sources":["../../src/render/ChangeSupport.js"],"sourcesContent":["export default class ChangeSupport {\n  constructor(eventBus) {\n    this._listeners = {};\n\n    eventBus.on('elements.changed', ({ elements }) => {\n      this.elementsChanged(elements);\n    });\n\n    eventBus.on('root.remove', context => {\n      const oldRootId = context.root.id;\n\n      if (this._listeners[oldRootId]) {\n\n        eventBus.once('root.add', context => {\n          const newRootId = context.root.id;\n\n          this.updateId(oldRootId, newRootId);\n        });\n\n      }\n\n    });\n\n    eventBus.on('element.updateId', ({ element, newId }) => {\n      this.updateId(element.id, newId);\n    });\n  }\n\n  elementsChanged(elements) {\n    const invoked = {};\n\n    const elementsLength = elements.length;\n\n    for (let i = 0; i < elementsLength; i++) {\n      const { id } = elements[i];\n\n      if (invoked[id]) {\n        return;\n      }\n\n      invoked[id] = true;\n\n      const listenersLength = this._listeners[id] && this._listeners[id].length;\n\n      if (listenersLength) {\n        for (let j = 0; j < listenersLength; j++) {\n\n          // listeners might remove themselves before they get called\n          this._listeners[id][j] && this._listeners[id][j]();\n        }\n      }\n    }\n  }\n\n  onElementsChanged(id, listener) {\n    if (!this._listeners[id]) {\n      this._listeners[id] = [];\n    }\n\n    // avoid push for better performance\n    this._listeners[id][this._listeners[id].length] = listener;\n  }\n\n  offElementsChanged(id, listener) {\n    if (!this._listeners[id]) {\n      return;\n    }\n\n    if (listener) {\n      const idx = this._listeners[id].indexOf(listener);\n\n      if (idx !== -1) {\n        this._listeners[id].splice(idx, 1);\n      }\n    } else {\n      this._listeners[id].length = 0;\n    }\n  }\n\n  updateId(oldId, newId) {\n    if (this._listeners[oldId]) {\n\n      this._listeners[newId] = this._listeners[oldId];\n\n      delete this._listeners[oldId];\n\n    }\n  }\n}\n\nChangeSupport.$inject = [ 'eventBus' ];"],"mappings":"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"}
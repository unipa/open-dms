{"version":3,"file":"IdChangeBehavior.js","names":["forEach","CommandInterceptor","is","getBusinessObject","ID","IdChangeBehavior","constructor","eventBus","executed","updateIds","bind","context","element","oldProperties","properties","bo","shouldSkipUpdate","definitions","getDefinitions","drgElements","get","drgElement","updateElementReferences","id","artifacts","artifact","updateAssociationReferences","newProperties","isIdChange","$inject","$parent","oldId","handlers","authorityRequirement","requiredAuthority","requiredDecision","requiredInput","href","informationRequirement","knowledgeRequirement","requiredKnowledge","handler","key","sourceRef","targetRef"],"sources":["../../../../src/features/modeling/behavior/IdChangeBehavior.js"],"sourcesContent":["import { forEach } from 'min-dash';\r\n\r\nimport CommandInterceptor from 'diagram-js/lib/command/CommandInterceptor';\r\n\r\nimport {\r\n  is,\r\n  getBusinessObject\r\n} from '../../../util/ModelUtil';\r\n\r\nconst ID = 'id';\r\n\r\n\r\nexport default class IdChangeBehavior extends CommandInterceptor {\r\n  constructor(eventBus) {\r\n    super(eventBus);\r\n\r\n    this.executed('element.updateProperties', this.updateIds.bind(this));\r\n  }\r\n\r\n  updateIds({ context }) {\r\n    const { element, oldProperties, properties } = context;\r\n\r\n    const bo = getBusinessObject(element);\r\n\r\n    if (this.shouldSkipUpdate(bo, oldProperties, properties)) {\r\n      return;\r\n    }\r\n\r\n    const definitions = getDefinitions(bo);\r\n\r\n    const drgElements = definitions.get('drgElement');\r\n    drgElements.forEach(drgElement => {\r\n      updateElementReferences(drgElement, oldProperties.id, properties.id);\r\n    });\r\n\r\n    const artifacts = definitions.get('artifact');\r\n    artifacts.forEach(artifact => {\r\n      updateAssociationReferences(artifact, oldProperties.id, properties.id);\r\n    });\r\n  }\r\n\r\n  shouldSkipUpdate(bo, oldProperties, newProperties) {\r\n    return !isIdChange(oldProperties, newProperties) ||\r\n     (!is(bo, 'dmn:DRGElement') && !is(bo, 'dmn:TextAnnotation'));\r\n  }\r\n}\r\n\r\nIdChangeBehavior.$inject = [ 'eventBus' ];\r\n\r\n\r\n// helpers //////////////////////\r\n\r\nfunction isIdChange(oldProperties, properties) {\r\n  return ID in oldProperties && ID in properties;\r\n}\r\n\r\n\r\n/**\r\n * Walk up the tree until at the root to get to dmn:Definitions.\r\n *\r\n * @param {ModdleElement} element\r\n */\r\nfunction getDefinitions(element) {\r\n  let definitions = element;\r\n\r\n  while (!is(definitions, 'dmn:Definitions')) {\r\n    definitions = definitions.$parent;\r\n  }\r\n\r\n  return definitions;\r\n}\r\n\r\nfunction updateElementReferences(element, oldId, id) {\r\n\r\n  const handlers = {\r\n\r\n    authorityRequirement: () => {\r\n      element.authorityRequirement.forEach(authorityRequirement => {\r\n        const {\r\n          requiredAuthority,\r\n          requiredDecision,\r\n          requiredInput\r\n        } = authorityRequirement;\r\n\r\n        if (requiredAuthority && requiredAuthority.href === `#${oldId}`) {\r\n          requiredAuthority.href = `#${id}`;\r\n        }\r\n\r\n        if (requiredDecision && requiredDecision.href === `#${oldId}`) {\r\n          requiredDecision.href = `#${id}`;\r\n        }\r\n\r\n        if (requiredInput && requiredInput.href === `#${oldId}`) {\r\n          requiredInput.href = `#${id}`;\r\n        }\r\n      });\r\n    },\r\n\r\n    informationRequirement: () => {\r\n      element.informationRequirement.forEach(informationRequirement => {\r\n        const { requiredDecision, requiredInput } = informationRequirement;\r\n\r\n        if (requiredDecision && requiredDecision.href === `#${oldId}`) {\r\n          requiredDecision.href = `#${id}`;\r\n        }\r\n\r\n        if (requiredInput && requiredInput.href === `#${oldId}`) {\r\n          requiredInput.href = `#${id}`;\r\n        }\r\n      });\r\n    },\r\n\r\n    knowledgeRequirement: () => {\r\n      element.knowledgeRequirement.forEach(knowledgeRequirement => {\r\n        const { requiredKnowledge } = knowledgeRequirement;\r\n\r\n        if (requiredKnowledge && requiredKnowledge.href === `#${oldId}`) {\r\n          requiredKnowledge.href = `#${id}`;\r\n        }\r\n      });\r\n    }\r\n\r\n  };\r\n\r\n  forEach(handlers, (handler, key) => {\r\n\r\n    if (element[key]) {\r\n      handler();\r\n    }\r\n\r\n  });\r\n}\r\n\r\nfunction updateAssociationReferences(element, oldId, id) {\r\n\r\n  const handlers = {\r\n    sourceRef: () => {\r\n      const { sourceRef } = element;\r\n\r\n      if (sourceRef.href === `#${oldId}`) {\r\n        sourceRef.href = `#${id}`;\r\n      }\r\n    },\r\n    targetRef: () => {\r\n      const { targetRef } = element;\r\n\r\n      if (targetRef.href === `#${oldId}`) {\r\n        targetRef.href = `#${id}`;\r\n      }\r\n    }\r\n  };\r\n\r\n  forEach(handlers, (handler, key) => {\r\n\r\n    if (element[key]) {\r\n      handler();\r\n    }\r\n\r\n  });\r\n}\r\n"],"mappings":"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"}
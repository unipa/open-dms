{"version":3,"file":"UpdatePropertiesHandler.js","names":["isObject","isDefined","reduce","getBusinessObject","ID","EditPropertiesHandler","constructor","elementRegistry","moddle","_elementRegistry","_moddle","execute","context","element","properties","bo","updateProperties","changed","oldProperties","revert","newProps","ids","result","value","key","propertyValue","get","isContainer","Error","isIdChange","unclaim","updateId","claim","set","$inject","newId","o"],"sources":["../../../../src/features/modeling/cmd/UpdatePropertiesHandler.js"],"sourcesContent":["import {\n  isObject,\n  isDefined,\n  reduce\n} from 'min-dash';\n\nimport {\n  getBusinessObject\n} from '../../../util/ModelUtil';\n\nconst ID = 'id';\n\n\n/**\n * A generic handler that implements property editing.\n */\nexport default class EditPropertiesHandler {\n\n  constructor(elementRegistry, moddle) {\n    this._elementRegistry = elementRegistry;\n    this._moddle = moddle;\n  }\n\n  /**\n   * <do>\n   */\n  execute(context) {\n\n    const {\n      element,\n      properties\n    } = context;\n\n    const bo = getBusinessObject(element);\n\n    const {\n      changed,\n      oldProperties\n    } = this.updateProperties(bo, properties);\n\n    context.oldProperties = oldProperties;\n\n    return [\n      ...changed,\n      element\n    ];\n  }\n\n  /**\n   * <undo>\n   */\n  revert(context) {\n    const {\n      element,\n      oldProperties\n    } = context;\n\n    var bo = getBusinessObject(element);\n\n    var {\n      changed\n    } = this.updateProperties(bo, oldProperties);\n\n    return [\n      ...changed,\n      element\n    ];\n  }\n\n\n  /**\n   * Update properties of the given business object\n   * and return { changed, oldProperties }.\n   */\n  updateProperties(bo, newProps) {\n\n    const ids = this._moddle.ids;\n\n    // Reduce over all new properties and return\n    //\n    // {\n    //  changed,\n    //  oldProperties\n    // }\n    return reduce(newProps, (result, value, key) => {\n\n      const propertyValue = bo.get(key);\n\n      // handle nested update\n      if (isContainer(value)) {\n\n        if (!isContainer(propertyValue)) {\n          throw new Error(\n            `non-existing property <${key}>: cannot update values`\n          );\n        }\n\n        let {\n          changed,\n          oldProperties\n        } = this.updateProperties(propertyValue, value);\n\n        return {\n          changed: [\n            ...result.changed,\n            ...changed,\n            propertyValue\n          ],\n          oldProperties: {\n            ...result.oldProperties,\n            [key]: oldProperties\n          }\n        };\n      }\n\n      // handle ID change\n      if (key === ID && isIdChange(bo, value)) {\n        ids.unclaim(bo[ID]);\n\n        this._elementRegistry.updateId(bo, value);\n\n        ids.claim(value, bo);\n      }\n\n      // handle plain update\n      bo.set(key, value);\n\n      return {\n        changed: result.changed,\n        oldProperties: {\n          ...result.oldProperties,\n          [key]: propertyValue\n        }\n      };\n\n    }, { changed: [], oldProperties: { } });\n  }\n\n}\n\nEditPropertiesHandler.$inject = [ 'elementRegistry', 'moddle' ];\n\n// helpers //////////////////////\n\nfunction isIdChange(element, newId) {\n  return element[ID] !== newId;\n}\n\n\nfunction isContainer(o) {\n  return (\n    isDefined(o) &&\n    isObject(o)\n  );\n}"],"mappings":"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"}
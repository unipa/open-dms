@page
@using OpenDMS.Domain.Constants;
@using OpenDMS.Domain.Enumerators
@model IndexModel
@{
    ViewData["Title"] = "Scheda " + (Model.Document.ContentType == OpenDMS.Domain.Enumerators.ContentType.Folder ? "Fascicolo" : "Documento");
    if (Model.ModalView)
        Layout = "_Layout";
    else
        Layout = "_MenuLayout";
}


<div class="Header">

    @if (!Model.ModalView)
    {
        @await  Component.InvokeAsync("CompanyLogo")
    }
    <i class="DocumentIcon fa @(Model.Document.ContentType == OpenDMS.Domain.Enumerators.ContentType.Folder ? "fa-folder" : @Model.Document.Icon)" style=";position:relative;color:@(Model.Document.IconColor)">
        @Html.Raw(Model.Document.ContentType == OpenDMS.Domain.Enumerators.ContentType.Folder ? "<span style='position:absolute;margin:-21%;font-size:.4em;left:50%;top:50%;color:#fff;' class='"+Model.Document.Icon+"'></span>" : "")
    </i>

    <h1>
        <small class="DocumentType">@Model.DocumentTypeName</small>
        <span class="Description">@Model.Document.Description</span>
        @if (!String.IsNullOrEmpty(@Model.Document.DocumentType.Description))
        {
            <i class="infoButton fa fa-info-circle" title="@Model.Document.DocumentType.Description"></i>
        }
    </h1>
    @if (Model.Document.ContentType == OpenDMS.Domain.Enumerators.ContentType.Folder)
    {
        @await  Component.InvokeAsync("DocumentFilters")
    }
    <div class="right-header">
        <ul class="nav nav-toolbar">
            @if (Model.imageId == 0)
            {
                @if (Model.CanAddContent && (Model.Document.ContentType == OpenDMS.Domain.Enumerators.ContentType.Folder && Model.CanAddContent && Model.Document.DocumentStatus != OpenDMS.Domain.Enumerators.DocumentStatus.Stored && Model.Document.DocumentStatus != OpenDMS.Domain.Enumerators.DocumentStatus.Deleted))
                {
                    <li id="tbCopy"><a href="#" class="MobileIcon" onclick="return Copy(@Model.DocumentId)"><i class="fa fa-files-o"></i> Copia</a></li>
                    <li id="tbPaste"><a href="#" class="MobileIcon" onclick="return Paste(@Model.DocumentId)"><i class="fa fa-clipboard"></i> Incolla</a></li>
                    <li id="tbCutAndPaste"><a href="#" class="MobileIcon" onclick="return Paste(@Model.DocumentId,true)"><i class="fa fa-cut"></i> Taglia & Incolla</a></li>
                }

                @if (Model.CanShare)
                {
                    @if (Model.Document.ContentType == OpenDMS.Domain.Enumerators.ContentType.Document)
                    {
                        <li id="tbFolder"><a href="#" class="MobileIcon" onclick="return AddFolder(@Model.DocumentId)"><i class="fa fa-folder"></i> Fascicola</a></li>
                    }
                    <li id="tbShare"><a href="#" class="MobileIcon" onclick="return Share(@Model.DocumentId)"><i class="fa fa-share-alt"></i> Condividi</a></li>
                    @if (Model.Document.ContentType == OpenDMS.Domain.Enumerators.ContentType.Document && Model.Document.Image != null && Model.CanSend)
                    {
                        <li id="tbMail"><a href="#" class="MobileIcon" onclick="return Send(@Model.DocumentId)"><i class="fa fa-envelope"></i> Invia</a></li>
                    }
                }
                <li style="margin-right:24px"></li>
                @if (!Model.ModalView)
                {
                    @await  Component.InvokeAsync("AddDocument")
                }
            }
            else
            {
                <li>
                    <h2>
                        @Html.Raw("v" +Model.Document.Image.VersionNumber + "." + Model.Document.Image.RevisionNumber)
                    </h2>
                </li>
            }
            @if (Model.ModalView)
            {
                <li id="tbExpand"><a href="#" onclick="return ExpandView(this,@Model.DocumentId)"><i class="fa fa-expand"></i></a></li>
                <li id="tbclose"><a href="#" onclick="return CloseWindow()"><i class="fa fa-times"></i></a></li>
            }
        </ul>

    </div>
</div>

<div class="FolderPathPanel" style="margin-right:100px">
    <i class="fa fa-folder divider"></i> <a href="#" target="_top" class="" onclick="return ShowDocument(0)">Archivio Fascicoli</a>
    @if (!String.IsNullOrEmpty(Model.Document.DocumentType.Id) && Model.Document.ContentType == OpenDMS.Domain.Enumerators.ContentType.Folder)
    {
        <i class="divider">\</i> <a href="/Folders/Documents?DocumentType=@Model.Document.DocumentType.Id" target="_top">@Model.Document.DocumentTypeName</a>
    }
    @foreach (var P in Model.Document.Path)
    {
        <i class="divider">\</i> <a href="#" target="_top" onclick="return ShowDocument(@P.Id)">@P.Description</a>
    }
    <i class="divider">\</i> <strong>@Model.Document.Description</strong>
    <b style="position:absolute;right:-100px;top:0px;padding:4px 8px;">ID: @Model.DocumentId</b>
</div>

@if (Model.Document.Protocol != null && !String.IsNullOrEmpty(Model.Document.Protocol.Number))
{
    <div class="Content">
        <b>Protocollo Nr.@Model.Document.Protocol.Number </b> del @Model.Document.Protocol.Date.ToString("dd/MM/yyyy hh:mm:ss")
        @if (!String.IsNullOrEmpty(Model.Document.Protocol.ExternalProtocolURL))
        {
            <a class="btn btn-link btn-xs" style="padding:2px 12px;font-weight:600" href="@Model.Document.Protocol.ExternalProtocolURL" target="_blank"><i class="fa fa-qrcode"></i> Apri Scheda Protocollo</a>
        }
    </div>
}


<div class="nav-toolbar-container Desktop MainToolbar">
    <ul class="nav nav-toolbar">
        @if (Model.CanEditForm)
        {
            <li id="tbEditContent"><a href="#" onclick="return EditForm()" title="Modifica il Form"><i class="fa fa-pencil-square"></i> Modifica</a></li>
        }
        <li class="MenuAttachmentPanel"><a class="" title="Allegati" onclick="return ShowPanel('AttachmentPanel')" href="#"><i class="fa fa-paperclip"></i>Allegati<span class="@(Model.AttachmentsCount > 0 ? "" : "hidden") badgeAttachments badge badge-info">@Model.AttachmentsCount</span></a></li>
        <li class="MenuLinkPanel"><a class="" title="Collegati" onclick="return ShowPanel('LinkPanel')" href="#"><i class="fa fa-link"></i>Collegati<span class="@(Model.LinksCount > 0 ? "" : "hidden") badgeLinks badge badge-info">@Model.LinksCount</span></a></li>
        <li class="MenuFolderPanel"><a class="" onclick="return ShowPanel('FolderPanel')" title="Fascicoli" href="#"><i class="fa fa-folder"></i><span class="@(Model.FoldersCount > 0 ? "" : "hidden") badgeFolders badge badge-info">@Model.FoldersCount</span></a></li>
        <li class="separator"></li>
        @if (Model.Document.Image != null && Model.Signatures.Length > 0)
        {
            <li class="MenuSignaturePanel"><a class="" onclick="return ShowPanel('SignaturePanel')" href="#"><i class="fa fa-pencil"></i>Firme<span class="@(Model.Signatures.Length > 0 ? "" : "hidden") badgeSignatures badge badge-info">@Model.Signatures.Length</span></a></li>
        }
    </ul>

    <ul class="nav nav-toolbar">
        @if (Model.CanViewTask)
        {
            <li class="MenuTasksPanel hidden"><a onclick="return ShowPanel('TasksPanel')" title="Attività da svolgere" href="#"><i class="fa fa-bell"></i><span class="badgeTasks badge badge-warning"></span></a></li>
        }
        @if (Model.CanViewTask)
        {
            <li class="MenuBPMPanel"><a onclick="return ShowPanel('BPMPanel')" href="#" title="Stato dei Processi"><i class="fa fa-cogs"></i></a></li>
        }
        <li class="MenuRefreshPanel"><a onclick="window.location.reload(true)" href="#" title="Ricarica la scheda"><i class="fa fa-refresh"></i></a></li>

        <li>
            <a href="#" role="button" title="Azioni sul documento..." class="dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fa fa-ellipsis-v"></i>
            </a>
            <ul class="dropdown-menu">

                @if (Model.CanEdit && Model.Document.DocumentStatus != OpenDMS.Domain.Enumerators.DocumentStatus.Stored && Model.Document.DocumentStatus != OpenDMS.Domain.Enumerators.DocumentStatus.Deleted)
                {
                    <li id="MenuEditPanel"><a onclick="return ShowPanel('EditPanel')" href="#"><i class="fa fa-keyboard-o"></i>Modifica Metadati...</a></li>
                }
                else
                {
                    <li class="MenuProtocolPanel"><a class="" title="Informazio di classificazione" onclick="return ShowPanel('ProtocolPanel')" href="#"><i class="fa fa-info-circle"></i> Metadati</a></li>
                }
                <li class="MenuAuthPanel"><a class="" onclick="return ShowPanel('AuthPanel')" title="Autorizzazioni" href="#"><i class="fa fa-unlock"></i> Autorizzazioni...</a></li>
                @if (Model.Document.Image != null && (Model.Document.Image.VersionNumber > 1 || Model.Document.Image.RevisionNumber > 0))
                {
                    <li class="MenuVersionPanel"><a class="" title="Versioni" onclick="return ShowPanel('VersionPanel')" href="#"><i class="fa fa-file-pdf-o"></i>Versioni<span class="badgeVersions badge badge-info">@Model.Versions.Count</span></a></li>
                }
                @if (Model.CanViewRegistry)
                {
                    <li class="MenuHistoryPanel"><a class="" title="Registro degli Eventi" onclick="return ShowPanel('HistoryPanel')" href="#"><i class="fa fa-clock-o"></i> Registro Eventi</a></li>
                }
                <li class="separator"></li>
                @if (Model.CanEdit && (Model.Document.DocumentStatus == OpenDMS.Domain.Enumerators.DocumentStatus.Stored || Model.Document.DocumentStatus == OpenDMS.Domain.Enumerators.DocumentStatus.Deleted))
                {
                    <li class="MenuRestorePanel"><a class="" onclick="return Restore(@Model.DocumentId)" href="#"><i class="fa fa-unlock"></i> Ripristina</a></li>
                }
                @if (Model.Document.DocumentStatus != OpenDMS.Domain.Enumerators.DocumentStatus.Draft && (Model.IsAdmin || (Model.Document.Owner == Model.User.Identity?.Name && Model.CanEdit)))
                {
                    <li class="MenuStorePanel"><a class="" onclick="return MakeDraft(@Model.DocumentId)" title="Trasforma in bozza il documento" href="#"><i class="fa fa-eye-slash"></i> Metti in Bozza</a></li>
                }

                @if (Model.CanEdit && Model.Document.DocumentStatus == OpenDMS.Domain.Enumerators.DocumentStatus.Draft)
                {
                    <li class="MenuStorePanel"><a class="" onclick="return Activate(@Model.DocumentId)" title="Rende pubblico il documento" href="#"><i class="fa fa-eye"></i> Rilascia</a></li>
                }
                @if (Model.CanEdit && Model.Document.DocumentStatus != OpenDMS.Domain.Enumerators.DocumentStatus.Stored && Model.Document.DocumentStatus != OpenDMS.Domain.Enumerators.DocumentStatus.Deleted)
                {
                    <li class="MenuStorePanel"><a class="" onclick="return Storicize(@Model.DocumentId)" title="Sposta il documento sull'archivio storico rendendolo non modificabile" href="#"><i class="fa fa-lock"></i> Archivia</a></li>
                }
                @if (Model.CanDelete && Model.Document.DocumentStatus != OpenDMS.Domain.Enumerators.DocumentStatus.Stored && Model.Document.DocumentStatus != OpenDMS.Domain.Enumerators.DocumentStatus.Deleted)
                {
                    <li id="MenuDeletePanel"><a onclick="return ShowPanel('DeletePanel')" href="#"><i class="fa fa-trash-o"></i> Elimina...</a></li>
                }
            </ul>
        </li>
    </ul>
</div>



<div class="Page">
    <div class="MainPanel">
        @await  Component.InvokeAsync(Model.Viewer, Model)
        @if (Model.Document.DocumentStatus == DocumentStatus.Draft)
        {
            <span class="badge badge-warning" style="position:absolute;right:24px;top: 49px;
    border: 1px solid;
    border-top: none;
    background-color: #fff;
    color: darkorange !important;
    border-color: #aaa;">
                <i class="fa fa-pencil-square"></i> Documento in Bozza
            </span>
        } else
        @if (Model.Document.DocumentStatus == DocumentStatus.Deleted)
        {
        <span class="badge badge-danger" style="position:absolute;right:24px;top: 49px;
    border: 1px solid;
    border-top: none;
    background-color: #fff;
    color: crimson !important;
    border-color: #aaa;">
            <i class="fa fa-trash-o"></i> Documento Cancellato
        </span>
        } else
        @if (Model.Document.DocumentStatus == DocumentStatus.Stored)
        {
        <span class="badge badge-info" style="position:absolute;right:24px;top: 49px;
    border: 1px solid;
    border-top: none;
    background-color: #fff;
    color: green !important;
    border-color: #aaa;">
            <i class="fa fa-lock"></i> Documento Conservato
        </span>
        }
    </div>
    <div class="hidden LeftPanel EditPanel">
        <div id="Message_Target"></div>
        <div class="Header">
            <h1><i class="fa fa-keyboard-o"></i> Modifica Metadati</h1>
            <a href="#" onclick="return ShowPanel('')" class=""><i class="fa fa-times"></i></a>
        </div>
        <form id="htmlform" class="MainPanel">
                @await  Component.InvokeAsync("EditMetaForm", Model.Document )
        </form>
        <div class="Bottom">
            <button type="submit" class="btn btn-primary" onclick="return SaveEditDocument()">Memorizza</button>
            <a href="#" onclick="return ShowPanel('')"  class="btn">Esci</a>
        </div>
    </div>
    <div class="hidden LeftPanel DeletePanel">
        <div class="Header">
            <h1><i class="fa fa-trash-o"></i> Elimina Documento</h1>
            <a href="#" onclick="return ShowPanel('')" class=""><i class="fa fa-times"></i></a>
        </div>
        <div class="Panel">
            <label>Indica una motivazione</label>
            <div>
                <input type="text" id="DeleteJustification" required class="required" style="width:100%"/>
                @if (Model.Document.ContentType == OpenDMS.Domain.Enumerators.ContentType.Folder)
                {
                    <div>
                        <p>
                            <i class="fa fa-info-circle"></i> 
                            Per motivi di sicurezza i documenti contenuti in questo fascicolo non saranno cancellati.<br/>
                            Spunta l'opzione qui sotto per eliminare tutto il contenuto di questo fascicolo
                        </p>
                        <br />
                        <input type="checkbox" id="DeleteRecursive" value="true" /> Elimina tutti i documenti contenuti nel fascicolo
                        <br />
                        <br />
                    </div>
                }
                <div style="padding-top:10px">
                    <a class="btn btn-secondary" onclick="return DeleteDocument(@Model.DocumentId)" href="#">Cancella</a>
                    <a class="btn btn-link" onclick="return ShowPanel('')" href="#">Annulla</a>
                </div>
            </div>
        </div>
    </div>
    <div class="hidden LeftPanel SignaturePanel">
        <div class="Header">
            <h1><i class="fa fa-pencil"></i> Firme Digitali</h1>
            <a href="#" onclick="return ShowPanel('')" class=""><i class="fa fa-times"></i></a>
        </div>
        <div class="Panel">
            @foreach (var V in Model.Signatures)
            {
                <h3>@V.SignatureType<span class="pull-right">@V.SignDate (UTC)</span></h3>
                <div class="Row">
                    <label>Impronta</label>
                    <span>@V.Digest?.Substring(0,32)<br />@V.Digest?.Substring(32)</span>
                </div>

                @if (!String.IsNullOrEmpty(V.SerialNumber))
                {
                    <div class="Row">
                        <label>Serial Number</label>
                        <span>@V.SerialNumber</span>
                    </div>
                }
                @if (!String.IsNullOrEmpty(V.TimeStamp))
                {
                    <div class="Row">
                        <label>Timestamp</label>
                        <span>@V.TimeStamp</span>
                    </div>
                }
                @if (!String.IsNullOrEmpty(V.Location))
                {
                    <div class="Row">
                        <label>Location</label>
                        <span>@V.Location</span>
                    </div>
                }
                @if (!String.IsNullOrEmpty(V.Reason))
                {
                    <div class="Row">
                        <label>Reason</label>
                        <span>@V.Reason</span>
                    </div>
                }


                @foreach (var SigningCertificate in V.Certificates)
                {
                    <h3>Certificato S/N:@SigningCertificate.SerialNumber<code>@SigningCertificate.Version</code></h3>
                    <div class="Row">
                        <label>Validità</label>
                        <span>
                            @SigningCertificate.NotBefore - @SigningCertificate.NotAfter (UTC)
                            <code>
                                @(
                                    SigningCertificate.IsValid(DateTime.UtcNow) ? "OGGI VALIDO" : "OGGI NON VALIDO"
                                    )
                            </code>
                        </span>
                    </div>

                    <div class="Row">
                        <label>Rilasciato a</label>
                        <span>@SigningCertificate.Subject.Nome @SigningCertificate.Subject.Cognome <code>@SigningCertificate.Subject.CodiceIdentita</code></span>
                    </div>
                    <div class="Row">
                        <label>Codice Fiscale</label>
                        <span>@SigningCertificate.Subject.CodiceFiscale</span>
                    </div>
                    @if (!String.IsNullOrEmpty(SigningCertificate.Subject.DatadiNascita))
                    {
                        <div class="Row">
                            <label>Data di Nascita</label>
                            <span>@SigningCertificate.Subject.DatadiNascita</span>
                        </div>
                    }

                    <div class="Row">
                        <label>Organizzazione</label>
                        <span>@SigningCertificate.Subject.Organizzazione</span>
                    </div>
                    @if (!String.IsNullOrEmpty(SigningCertificate.Subject.Strada))
                    {
                        <div class="Row">
                            <label>Località</label>
                            <span>@SigningCertificate.Subject.Strada - @SigningCertificate.Subject.CodicePostale @SigningCertificate.Subject.Localita - @SigningCertificate.Subject.CodicePaese - @SigningCertificate.Subject.Stato </span>
                        </div>
                    }
                    @if (!String.IsNullOrEmpty(SigningCertificate.Subject.Email))
                    {
                        <div class="Row">
                            <label>Email</label>
                            <span>@SigningCertificate.Subject.Email</span>
                        </div>

                    }


                    <div class="Row">
                        <label>Emesso Da</label><span> @SigningCertificate.Issuer.Organizzazione <code>@SigningCertificate.Issuer.CodiceFiscale</code></span>
                    </div>

                    <div class="Row">
                        <label>Località</label>
                        <span>@SigningCertificate.Issuer.Strada - @SigningCertificate.Issuer.CodicePostale @SigningCertificate.Issuer.Localita - @SigningCertificate.Issuer.CodicePaese - @SigningCertificate.Issuer.Stato </span>
                    </div>
                }
            }
        </div>
    </div>
    <div class="hidden LeftPanel VersionPanel">
        <div class="Header">
            <h1><i class="fa fa-file-pdf-o"></i> Registro Versioni</h1>
            <a href="#" onclick="return ShowPanel('')" class=""><i class="fa fa-times"></i></a>
        </div>
        <div class="MainPanel">
            @foreach (var V in Model.Versions)
            {
                <div class="VersionRow" onclick="ShowPreview(@Model.Document.Id, @V.ImageId)">
                    <span class="VersionNumber">@(V.VersionNumber + "." + V.RevisionNumber)</span>
                    @*<img class="Avatar" src="/internalapi/identity/mime/@V.FileExtension" />*@
                    <span class="VersionName">@System.IO.Path.GetFileName(V.FileName)</span>
                    <span class="VersionSize">@Model.FormatFileSize(V.FileSize)</span>
                    <span class="VersionDate">@V.CreationDate.ToString("dd/MM/yyyy HH:mm").Replace(DateTime.Now.Date.ToString("dd/MM/yyyy"),"Oggi") (UTC)</span>
                    <div style="text-align:center;width:20px">
                        <i class="fa fa-pencil" @(V.SignatureStatus == OpenDMS.Domain.Enumerators.JobStatus.Completed ? "" : "style=display:none")></i>
                    </div>

                    <div style="text-align:center;min-width:20px">
                        <i class="fa fa-send" @(V.SendingStatus == OpenDMS.Domain.Enumerators.JobStatus.Completed ? "" : "style=display:none")></i>
                    </div>
                    <div style="text-align:center;min-width:20px">
                        @if (Model.Document.Image?.Id != V.ImageId && Model.CanAddContent)
                        {
                            <a href="#" class="" onclick="return RestoreVersion(@Model.Document.Id, @V.ImageId)" title="Recupera Versione..."><i class="fa fa-upload"></i></a>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
    <div class="hidden LeftPanel AttachmentPanel">
        <div class="Header">
            <h1><i class="fa fa-paperclip"></i> Allegati</h1>
            @if (Model.CanAddContent)
            {
                <a href="#" onclick="return AddAttachment(@Model.DocumentId)">
                    <i class="fa fa-upload"></i> Carica file...
                </a>

                <a href="#" onclick="return PasteToAttachment(@Model.DocumentId)"><i class="fa fa-paste"></i> Incolla</a>
            }
            <a href="#" onclick="return UpdateAttachmentPanel()" class=""><i class="fa fa-refresh"></i></a>
            <a href="#" onclick="return ShowPanel('')" class=""><i class="fa fa-times"></i></a>
        </div>
        <div class="BackPanel">
            <div class="Attachments PreviewContainer"></div>
        </div>
    </div>
    <div class="hidden LeftPanel LinkPanel">
        <div class="Header">
            <h1><i class="fa fa-link"></i> Collegamenti</h1>
            @if (Model.CanAddContent)
            {
                <a href="#" onclick="return PasteToLink(@Model.DocumentId,false)"><i class="fa fa-plus"></i> Incolla</a>
            }

            <a href="#" onclick="return UpdateLinkPanel()" class=""><i class="fa fa-refresh"></i></a>
            <a href="#" onclick="return ShowPanel('')" class=""><i class="fa fa-times"></i></a>
        </div>
        <div class="BackPanel">
            <div class="Links PreviewContainer"></div>
        </div>
    </div>
    <div class="hidden LeftPanel AttachmentOfPanel">
        <div class="Header">
            <h1><i class="fa fa-paperclip"></i> Allegato di...</h1>
            <a href="#" onclick="return UpdateAttachmentOfPanel()" class=""><i class="fa fa-refresh"></i></a>
            <a href="#" onclick="return ShowPanel('')" class=""><i class="fa fa-times"></i></a>
        </div>
        <div class="BackPanel">
            <div class="AttachmentsOf PreviewContainer"></div>
        </div>
    </div>
    @*    <div class="hidden LeftPanel ClonePanel">
    <div class="Header">
    <h1><i class="fa fa-files-o"></i> Duplicati</h1>
    <a onclick="return ShowPanel('')" class=""><i class="fa fa-times"></i></a>
    </div>
    <div class="Panel">
    </div>
    </div>*@
    <div class="hidden LeftPanel FolderPanel">
        <div class="Header">
            <h1><i class="fa fa-folder"></i> Fascicoli</h1>
            @if (Model.CanShare)
            {
                <a href="#" onclick="return AddFolder( @Model.DocumentId )" class=""><i class="fa fa-plus"></i> Aggiungi...</a>
            }
            <a href="#" onclick="return UpdateFolderPanel()" class=""><i class="fa fa-refresh"></i></a>
            <a href="#" onclick="return ShowPanel('')" class=""><i class="fa fa-times"></i></a>
        </div>
        <div class="MainPanel">
            <div class="FoldersPanel"></div>
        </div>
    </div>
    <div class="hidden LeftPanel AuthPanel">
        <div class="Header">
            <h1><i class="fa fa-unlock"></i> Autorizzazioni</h1>
            @if (Model.CanAuthorize)
            {
                <a href="#" onclick="return Permissions(@Model.DocumentId)" class=""><i class="fa fa-plus"></i> Aggiungi...</a>
            }
            <a href="#" onclick="return UpdateAuthPanel()" class=""><i class="fa fa-refresh"></i></a>
            <a href="#" onclick="return ShowPanel('')" class=""><i class="fa fa-times"></i></a>
        </div>
        <div class="MainPanel">
            
            <div class="Permissions accordion"></div>
        </div>
    </div>
    <div class="hidden LeftPanel ProtocolPanel">
        <div class="Header">
            <h1><i class="fa fa-info-circle"></i> Informazioni</h1>
            <a href="#" onclick="return ShowPanel('')" class=""><i class="fa fa-times"></i></a>
        </div>
        <div class="MainPanel">
            @if (!String.IsNullOrEmpty(Model.Document.Protocol.Number))
            {
                <h3>Protocollo</h3>
                <div class="Row">
                    <label>Nr.</label>
                    <span>@Model.Document.Protocol.Number<code class="right-header">@Model.Document.Protocol.Date.ToString("dd/MM/yyyy HH:mm") (UTC)</code></span>
                </div>
                <div class="Row">
                    <label>Protocollatore</label>
                    <span>@Model.Document.Protocol.ProtocolUser<code class="right-header">@Model.Document.Protocol.ProtocolUser</code></span>
                </div>
            }

            <h3>Classificazione</h3>
            <div class="Row">
                <label>Categoria</label>
                <span>@Model.Document.DocumentTypeCategory<code class="right-header">#@Model.Document.DocumentType.CategoryId</code></span>
            </div>
            <div class="Row">
                <label>Tipologia</label>
                <span>@Model.Document.DocumentTypeName<code class="right-header">#@Model.Document.DocumentType.Id</code></span>
            </div>
            @if (!String.IsNullOrEmpty(Model.Document.DocumentType.DocumentNumberLabel))
            {
                <div class="Row">
                    <label>@Model.Document.DocumentType.DocumentNumberLabel</label>
                    <span>@Model.Document.DocumentNumberFormattedValue<code class="right-header">@Model.Document.DocumentNumber</code></span>
                </div>
            }
            @if (!String.IsNullOrEmpty(Model.Document.DocumentType.DocumentDateLabel))
            {
                <div class="Row">
                    <label>@Model.Document.DocumentType.DocumentDateLabel</label>
                    <span>@Model.Document.DocumentDate?.ToString("dd/MM/yyyy")</span>
                </div>
            }
            @if (Model.Document.RecipientList.Count() > 0)
            {
                <h3>Soggetti</h3>

                @foreach (var R in Model.Document.RecipientList.Where(r => r.RecipientType == OpenDMS.Domain.Enumerators.RecipientType.Sender))
                {
                    <div class="Row">
                        <label>Mittente</label>
                        <span>@R.ProfileName</span>
                    </div>
                }
                @if (Model.Document.RecipientList.Where(r => r.RecipientType == OpenDMS.Domain.Enumerators.RecipientType.To).Count() > 0)
                {
                    <div class="Row">
                        <label>Destinatari</label>
                        @foreach (var R in Model.Document.RecipientList.Where(r => r.RecipientType == OpenDMS.Domain.Enumerators.RecipientType.To))
                        {
                            <span>@R.ProfileName</span>
                        }
                    </div>
                }

                @if (Model.Document.RecipientList.Where(r => r.RecipientType == OpenDMS.Domain.Enumerators.RecipientType.CC).Count() > 0)
                {
                    <div class="Row">
                        <label>Destinatari CC</label>
                        @foreach (var R in Model.Document.RecipientList.Where(r => r.RecipientType == OpenDMS.Domain.Enumerators.RecipientType.CC))
                        {
                            <span>@R.ProfileName</span>
                        }
                    </div>
                }
                @if (Model.Document.RecipientList.Where(r => r.RecipientType == OpenDMS.Domain.Enumerators.RecipientType.CCr).Count() > 0)
                {
                    <div class="Row">
                        <label>Destinatari CCr</label>
                        @foreach (var R in Model.Document.RecipientList.Where(r => r.RecipientType == OpenDMS.Domain.Enumerators.RecipientType.CCr))
                        {
                            <span>@R.ProfileName</span>
                        }
                    </div>
                }
                @if (Model.Document.RecipientList.Where(r => r.RecipientType == OpenDMS.Domain.Enumerators.RecipientType.Customized).Count() > 0)
                {
                    <div class="Row">
                        <label>Altri</label>
                        @foreach (var R in Model.Document.RecipientList.Where(r => r.RecipientType == OpenDMS.Domain.Enumerators.RecipientType.Customized))
                        {
                            <span>@R.ProfileName</span>
                        }
                    </div>
                }
            }


            <h3>Metadati Obbligatori</h3>
            @if (!String.IsNullOrEmpty(Model.Document.DocumentType.DescriptionLabel))
            {
                <div class="Row">
                    <label>@Model.Document.DocumentType.DescriptionLabel</label>
                    <span>@Model.Document.Description</span>
                </div>
            }
            @foreach (var M in Model.Document.FieldList.Where(m => !m.Customized))
            {
                <div class="Row">
                    <label>@M.Title</label>
                    <span>@M.LookupValue<code class="right-header">#@M.Value</code></span>
                </div>
            }
            @if (Model.Document.FieldList.Any(m => m.Customized))
            {
                <h3>Metadati Facoltativi</h3>
            }
            @foreach (var M in Model.Document.FieldList.Where(m => m.Customized))
            {
                <div class="Row">
                    <label>@M.Title</label>
                    <span>@M.LookupValue<code class="right-header">#@M.Value</code></span>
                </div>
            }


            <h3>Riferimenti Temporali</h3>
            <div class="Row">
                <label>Data Registrazione</label>
                <span>@Model.Document.CreationDate</span>
            </div>

            @if (Model.Document.ExpirationDate.HasValue)
            {
                <div class="Row">
                    <label>Data Scadenza</label>
                    <span>@(Model.Document.ExpirationDate.Value.Year < 9999 ? Model.Document.ExpirationDate?.ToString("dd/MM/yyyy") : "Nessuna")</span>
                </div>
            }
            @if (Model.Document.DeletionDate.HasValue)
            {
                <div class="Row">
                    <label>Data Cancellazione</label>
                    <span>@Model.Document.DeletionDate?.ToString("dd/MM/yyyy")</span>
                </div>
            }

            @if (Model.Document.ConsolidationDate.HasValue)
            {
                <div class="Row">
                    <label>Data Consolidamento</label>
                    <span>@Model.Document.ConsolidationDate?.ToString("dd/MM/yyyy")</span>
                </div>
            }

        </div>
    </div>
    <div class="hidden LeftPanel HistoryPanel">
        <div class="Header">
            <h1><i class="fa fa-clock-o"></i> Registro Eventi</h1>
            @*<a onclick="return PrintHistory()" class=""><i class="fa fa-print"></i> Stampa</a>*@
            <a href="#" onclick="return UpdateHistoryPanel()" class=""><i class="fa fa-refresh"></i></a>
            <a href="#" onclick="return ShowPanel('')" class=""><i class="fa fa-times"></i></a>
        </div>
        <div class="Panel">
            <div style="position:relative;">
                <input type="textbox" class="HistorySearchText SearchText" placeholder="Cerca..." onchange="FilterHistory()" style="padding-right:100px" />
                <div style="position:absolute;right:2px;top:2px;">
                    <a href="#" role="button" class="SelectedFilter btn btn-link btn-xs dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fa fa-filter"></i>
                    </a>
                    <ul class="dropdown-menu HistoryFilters">
                        <li><a class="dropdown-item" onclick="return FilterHistory(0)" href="#"><i class="fa fa-check pull-right filter0"></i> Tutti</a></li>
                        <li><a class="dropdown-item" onclick="return FilterHistory(1)" href="#"><i class="fa fa-check pull-right hidden filter1"></i> Condivisioni</a></li>
                        <li><a class="dropdown-item" onclick="return FilterHistory(2)" href="#"><i class="fa fa-check pull-right hidden filter2"></i> Firme</a></li>
                        <li><a class="dropdown-item" onclick="return FilterHistory(3)" href="#"><i class="fa fa-check pull-right hidden filter3"></i> Spedizioni/Pubblicazioni</a></li>
                        <li><a class="dropdown-item" onclick="return FilterHistory(4)" href="#"><i class="fa fa-check pull-right hidden filter4"></i> Modifiche Metadati</a></li>
                        <li><a class="dropdown-item" onclick="return FilterHistory(5)" href="#"><i class="fa fa-check pull-right hidden filter5"></i> Modiifche Contenuto</a></li>
                        <li><a class="dropdown-item" onclick="return FilterHistory(6)" href="#"><i class="fa fa-check pull-right hidden filter6"></i> Modifiche Relazioni</a></li>
                        <li><a class="dropdown-item" onclick="return FilterHistory(7)" href="#"><i class="fa fa-check pull-right hidden filter7"></i> Accesso</a></li>
                    </ul>
                </div>
            </div>
            <div><h3>Elenco ordinato di eventi registrati sul documento.</h3></div>
            <div class="Panel">
                <div class="Histories"></div>
                <div class="HistoryLoader hidden">
                    <h3><i class="fa fa-clock-o"></i> Caricamento in corso...</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="hidden LeftPanel TasksPanel">
        <div class="Header">
            <h1><i class="fa fa-bell"></i> Attività</h1>
            <a href="#" onclick="return UpdateTaskPanel()" class=""><i class="fa fa-refresh"></i></a>
            <a href="#" onclick="return ShowPanel('')" class=""><i class="fa fa-times"></i></a>
        </div>
        <div class="MainPanel">
            <ul class="nav nav-list TaskList"></ul>
            <div class="ActiveBPMLoader hidden">
                <h3><i class="fa fa-clock-o"></i> Caricamento in corso...</h3>
            </div>
        </div>
    </div>

    <div class="hidden LeftPanel BPMPanel">
        @await Component.InvokeAsync("ProcessInfo", Model.DocumentId)
    </div>


    <div class="RightMenu">

        <div style="border-left: 1px solid #ddd;padding-top:0px;" class="MainPanel">
            <div class="sidebar-linklist-wrapper">
                <div class="link-list-wrapper">
                    <h3>Proprietà</h3>
                    <ul class="link-list">
                        <li class="MenuAttachmentPanel"><a onclick="return ShowPanel('AttachmentPanel')" href="#"><i class="fa fa-paperclip"></i>  Allegati <span class="@(@Model.AttachmentsCount > 0 ? "" : "hidden") badgeAttachments badge badge-info">@Model.AttachmentsCount</span></a></li>

                        <li class="MenuProtocolPanel"><a onclick="return ShowPanel('ProtocolPanel')" href="#"><i class="fa fa-info-circle"></i>  Metadati</a></li> 

                        @if (Model.Document.Image != null && Model.Signatures.Length > 0)
                        {
                            <li class="MenuSignaturePanel"><a onclick="return ShowPanel('SignaturePanel')" href="#"><i class="fa fa-pencil"></i>  Firme <span class="badgeSignatures badge badge-info">@Model.Signatures.Length</span></a></li>
                        }
                        <li class="MenuAuthPanel"><a onclick="return ShowPanel('AuthPanel')" href="#"><i class="fa fa-unlock"></i> Autorizzazioni</a></li>
                    </ul>
                    <h3>Relazioni</h3>
                    <ul class="link-list">
                        <li class="MenuLinkPanel"><a onclick="return ShowPanel('LinkPanel')" href="#"><i class="fa fa-link"></i>  Collegati <span class="@(@Model.LinksCount > 0 ? "" : "hidden") badgeLinks badge badge-info">@Model.LinksCount</span></a></li>
                        <li class="MenuFolderPanel"><a onclick="return ShowPanel('FolderPanel')" href="#"><i class="fa fa-folder"></i>  Fascicoli <span class="@(@Model.FoldersCount > 0 ? "" : "hidden") badgeFolders badge badge-info">@Model.FoldersCount</span></a></li>
                        <li class="MenuAttachmentOfPanel"><a onclick="return ShowPanel('AttachmentOfPanel')" href="#"><i class="fa fa-paperclip"></i>  Allegato di... <span class="@(@Model.AttachmentsOfCount > 0 ? "" : "hidden") badgeAttachmentsOf badge badge-info">@Model.AttachmentsOfCount</span></a></li>
                        @*<li class="MenuClonePanel"><a onclick="return ShowPanel('ClonePanel')" href="#"><i class="fa fa-files-o"></i>  Duplicati <span class="hidden badgeCopies badge badge-info"></span></a></li>*@
                    </ul>
                    <h3>Attività</h3>
                    <ul class="link-list">
                        @if (Model.CanViewTask)
                        {
                            <li class="MenuTasksPanel hidden"><a onclick="return ShowPanel('TasksPanel')" href="#"><i class="fa fa-bell"></i> Attività <span class="badgeTasks badge badge-warning"></span></a></li>
                        }
                        @if (Model.CanViewTask)
                        {
                            <li class="MenuBPMPanel"><a onclick="return ShowPanel('BPMPanel')" href="#" title="Workflow"><i class="fa fa-cogs"></i> Workflow</a></li>
                        }
                        @if (Model.Document.Image != null && (Model.Document.Image.VersionNumber > 1 || Model.Document.Image.RevisionNumber > 0))
                        {
                            <li class="MenuVersionPanel"><a onclick="return ShowPanel('VersionPanel')" href="#"><i class="fa fa-file-pdf-o"></i> Versioni <span class="badgeVersions badge badge-info">@Model.Document.Image.VersionNumber.@Model.Document.Image.RevisionNumber </span></a></li>
                        }
                        @if (Model.CanViewRegistry)
                        {
                            <li class="MenuHistoryPanel"><a onclick="return ShowPanel('HistoryPanel')" href="#"><i class="fa fa-clock-o"></i> Registro Eventi</a></li>
                        }
                    </ul>

                    <h3>Operazioni</h3>
                    <ul class="link-list">
                        @if (Model.CanEditForm)
                        {
                            <li id="tbEditContent"><a href="#" onclick="return EditForm()" title="Modifica il Form"><i class="fa fa-table"></i> Modifica</a></li>
                        }
                        @if (Model.CanEdit || Model.CanDelete)
                        {
                            @if (Model.CanEdit && Model.Document.DocumentStatus != OpenDMS.Domain.Enumerators.DocumentStatus.Stored && Model.Document.DocumentStatus != OpenDMS.Domain.Enumerators.DocumentStatus.Deleted)
                            {
                                <li id="MenuEditPanel"><a onclick="return ShowPanel('EditPanel')" href="#"><i class="fa fa-keyboard-o"></i> Modifica Metadati</a></li>
                            }
                            @if (Model.CanEdit && (Model.Document.DocumentStatus == OpenDMS.Domain.Enumerators.DocumentStatus.Stored || Model.Document.DocumentStatus == OpenDMS.Domain.Enumerators.DocumentStatus.Deleted))
                            {
                                <li class="separator"></li>
                                <li class="MenuRestorePanel"><a class="" onclick="return Restore(@Model.DocumentId)" href="#"><i class="fa fa-unlock"></i> Ripristina</a></li>
                            }
                            @if (Model.CanEdit && Model.Document.DocumentStatus == OpenDMS.Domain.Enumerators.DocumentStatus.Draft)
                            {
                                <li class="separator"></li>
                                <li class="MenuStorePanel"><a class="" onclick="return Activate(@Model.DocumentId)" title="Rende pubblico il documento" href="#"><i class="fa fa-web"></i> Rilascia</a></li>
                            }
                            @if (Model.CanEdit && Model.Document.DocumentStatus != OpenDMS.Domain.Enumerators.DocumentStatus.Stored && Model.Document.DocumentStatus != OpenDMS.Domain.Enumerators.DocumentStatus.Deleted)
                            {
                                <li class="MenuStorePanel"><a class="" onclick="return Storicize(@Model.DocumentId)" title="Sposta il documento sull'archivio storico rendendolo non modificabile" href="#"><i class="fa fa-lock"></i> Archivia</a></li>
                            }
                            @if (Model.CanDelete && Model.Document.DocumentStatus != OpenDMS.Domain.Enumerators.DocumentStatus.Stored && Model.Document.DocumentStatus != OpenDMS.Domain.Enumerators.DocumentStatus.Deleted)
                            {
                                <li class="separator"></li>
                                <li id="MenuDeletePanel"><a onclick="return ShowPanel('DeletePanel')" href="#"><i class="fa fa-trash-o"></i> Elimina</a></li>
                            }
                        }
                    </ul>
                    <div class="customActions hidden">
                        <ul class="link-list customActionList"></ul>
                    </div>

               </div>
            </div>
        </div>
    </div>
</div>



<script type="text/html" id="FoldersPanel">
    {{#Folders}}
        <div class="FolderRow">
            {{#path}}
                <a href="/?id={{id}}" target="_top" title="{{annotation}}"><i class="fa fa-folder"></i> {{description}}</a>
            {{/path}}
            <a href="/?id={{id}}" target="_top" title="{{documentTypeName}}"><i class="fa fa-folder-open"></i> {{description}}</a>
        @if (Model.CanRemoveContent)
        {
            <a class="RemoveFolder" href="#" onclick="return RemoveFolder({{id}}, @Model.DocumentId)" title="Rimuovi il documento da questo fascicolo..."><i class="fa fa-trash-o"></i></a>
        }
        </div>
    {{/Folders}}
    {{^Folders}}
        <div class="InfoPanel">
            <i class="fa fa-folder"></i>
            <h3>Il documento non è presente in alcun fascicolo</h3>
        @if (Model.CanAddContent)
        {
                            <p>Per inserire il documento su uno o più fascicoli premi il pulsante <strong>Aggiungi...</strong></p>
        }
        </div>
    {{/Folders}}
</script>
<script type="text/html" id="Permissions">
    {{#Permissions}}
        <div class="accordion-item">
            <div class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#acc{{profilePanelId}}">
                <img class="avatar" style="width:18px;height:18px;margin-right:8px" src="/internalapi/identity/avatar/{{profileType}}{{profileId}}" />
                {{profileName}}
                @if (Model.CanAuthorize)
                {
                                <a href="#" onclick="RemovePermissions('{{profile}}')" style="position:absolute;right:40px;top:8px;" title="Rimuovi le autorizzazioni..."><i class="fa fa-trash-o"></i></a>
                                <a href="#" onclick="EditPermissions('{{profile}}')" style="position:absolute;right:70px;top:8px;" title="Modifica le autorizzazioni..."><i class="fa fa-pencil"></i></a>
                }
            </div>
            <div id="acc{{profilePanelId}}" class="accordionbackpanel collapseOne accordion-collapse collapse">
                {{#permissions}}
                    <div class="CheckRow" style="padding:0 28px">
                        {{label}}
                        <i class="Permission{{authorization}}"></i>
                    </div>
                {{/permissions}}
            </div>
        </div>
    {{/Permissions}}
</script>
<script type="text/html" id="Histories">
    {{#HistoryEntries}}
                <div class="HistoryItem compressed" id="{{id}}"  onclick="$(this).toggleClass('compressed');">
                    <img class="avatar" src="/internalapi/identity/avatar/0{{userId}}" />
                    <div class="HistoryActor">
                        <label>{{sender}}</label>
                        {{#deputyUser && deputyUser != sender}}
                            <small>({{deputyUser}})</small>
                        {{/deputyUser && deputyUser != sender}}
                    </div>
                    <div class="HistoryNote">
                        <label>{{eventType}}</label>

                        <p>{{&description}}</p>
                        {{#details}}
                            <div class="CheckRow">
                                <label>{{&label}}</label>
                                <span>{{&values}}</span>
                            </div>
                        {{/details}}
                        <code>{{eventDateTime}}</code>
                    </div>
                </div>
    {{/HistoryEntries}}


</script>
<script type="text/html" id="Links">
    {{#Links}}
    <div class="PreviewRow" onclick="ShowPreview({{id}})">
        <div class="PreviewDocument">
            <image-viewer type="compatto" id="link" pages="1" documentId="{{id}}"  imageId="{{imageId}}" />
            @if (Model.CanRemoveContent)
            {
                        <a href="#" onclick="return RemoveLink({{id}})" class="action PreviewRemove"><i class="fa fa-trash-o" title="Rimuovi legame"></i></a>
            }
        </div>
        <span class="PreviewName">{{description}}<small>{{documentType}}</small></span>
        {{#protocol}}
        <span class="PreviewProtocol">PROT. {{protocol}}</span>
        {{/protocol}}
    </div>
    {{/Links}}
    {{^Links}}
            <div class="InfoPanel">
                <i class="fa fa-link small"></i>
                <h3>Questo documento non ha collegamenti con altri documenti</h3>
        @if (Model.CanAddContent)
        {

                            <p>Per creare un nuovo collegamento copia un documento negli appunti e usa <strong>Incolla</strong> per aggiungerlo qui</p>
        }
            </div>
    {{/Links}}
</script>
<script type="text/html" id="Attachments">
    {{#Attachments}}
    <div class="PreviewRow" onclick="ShowPreview({{id}})">
        <div class="PreviewDocument">
            <image-viewer type="compatto" id="link" pages="1"  documentId="{{id}}" imageId="{{imageId}}" />
            @if (Model.CanRemoveContent)
            {
                        <a class="action PreviewRemove" href="#" onclick="return RemoveAttachment({{id}})"><i class="fa fa-trash-o" title="Rimuovi legame"></i></a>
            }
        </div>
        <span class="PreviewName">{{description}}<small>{{documentType}}</small></span>
        {{#protocol}}
        <span class="PreviewProtocol">PROT. {{protocol}}</span>
        {{/protocol}}
    </div>
    {{/Attachments}}
    {{^Attachments}}
            <div class="InfoPanel">
                <i class="fa fa-paperclip small"></i>
                <h3>Questo documento non ha allegati</h3>
        @if (Model.CanAddContent)
        {
                            <p>Per aggiungere un nuovo allegato usa il pulsante <strong>Carica File...</strong> oppure <strong>Incolla</strong> qui un documento copiato negli appunti</p>
        }
            </div>
    {{/Attachments}}
</script>
<script type="text/html" id="TaskItems">
    {{#Items}}
    <li id="{{ id }}" style="display:flex;">
           <a href="#" onclick="openTask({{ id }})" style="display:flex;flex-direction:row;flex-grow:1;border-bottom:1px dashed #ddd">
               <img src="/internalapi/identity/avatar/{{ taskItemInfo.sender }}" class="avatarInList" style="margin-right:4px;" />
               <div style="display:flex;flex-direction:column;width:100%;position:relative;align-self:normal">
                       <b style="margin-bottom:-6px">{{ taskItemInfo.senderName }}</b>
                           {{#taskItemInfo.toList.length}}
                           <div style="font-size:.85rem">
                               A: {{#taskItemInfo.toList}}
                                   <span class="">
                                   {{description}}</span>
                               {{/taskItemInfo.toList}}
                           </div>
                           {{/taskItemInfo.toList.length}}
                            {{#taskItemInfo.ccList.length}}
                           <div style="font-size:.85rem">
                               CC: {{#taskItemInfo.ccList}}
                                   <span class="">
                                       {{description}}</span>
                               {{/taskItemInfo.ccList}}
                           </div>
                           {{/taskItemInfo.ccList.length}}

                   <div style="color: #222;margin-top:4px"> <i class="fa fa-bell"></i> {{&taskItemInfo.title }}</div>

                   <div style="position:absolute;top:2px;right:160px;text-align:right;font-size:.85rem;color:#888">
                         {{ percentage }}%
                   </div>

                   <div style="position:absolute;top:2px;right:0px; text-align:right;font-size:.85rem;color:#888">
                         {{ creationDateString }} <i class="fa fa-calendar"></i>
                   </div>
                   {{#expirationDateString}}
                   <div style="position:absolute;top:28px;right:0px; text-align:right;font-size:.85rem;color:crimson">
                         {{ expirationDateString }} <i class="fa fa-exclamation"></i>
                   </div>
                   {{/expirationDateString}}
               </div>
           </a>
       </li>
    {{/Items}}

             {{^Items}}
             <img src="/images/task_empty.svg" style="margin:auto;margin-top:25vh; max-width:256px" />
             {{/Items}}


</script>
<script type="text/html" id="BPMItems">
    {{#Items}}
    <li id="{{ id }}" style="display:flex;">
        <a href="#" onclick="openTask({{ id }})" style="display:flex;flex-direction:row;flex-grow:1;border-bottom:1px dashed #ddd;align-items: flex-start;">
            <img src="/internalapi/identity/avatar/{{ taskItemInfo.sender }}" class="avatarInList" style="margin-right:4px;" />
            <div style="display:flex;flex-direction:column;width:100%;position:relative;align-self:normal">
                    <b style="margin-bottom:-6px">{{ taskItemInfo.senderName }}</b>
                        {{#taskItemInfo.toList.length}}
                        <div style="font-size:.85rem">
                            A: {{#taskItemInfo.toList}}
                                <span class="">
                                {{description}}</span>
                            {{/taskItemInfo.toList}}
                        </div>
                        {{/taskItemInfo.toList.length}}
                         {{#taskItemInfo.ccList.length}}
                        <div style="font-size:.85rem">
                            CC: {{#taskItemInfo.ccList}}
                                <span class="">
                                    {{description}}</span>
                            {{/taskItemInfo.ccList}}
                        </div>
                        {{/taskItemInfo.ccList.length}}


                   {{#taskItemInfo.process.description}}
                   <div style="font-size:.85rem;color:#226;font-weight:700;margin-top:4px">
                        <i class="fa fa-sitemap"></i> {{&taskItemInfo.process.description }}
                   </div>
                   {{/taskItemInfo.process.description}}
                   <div style="color: #222;font-size:.85rem;"><i class="fa fa-comment"></i> {{&taskItemInfo.title }}</div>

                   <div style="position:absolute;top:2px;right:170px;text-align:right;font-size:.85rem;color:#888">
                         {{ percentage }}%
                   </div>

                   <div style="position:absolute;top:2px;right:0px; text-align:right;font-size:.85rem;color:#888">
                         {{ creationDateString }} <i class="fa fa-calendar"></i>
                   </div>
                   {{#expirationDateString }}
                   <div style="position:absolute;top:28px;right:0px; text-align:right;font-size:.85rem;color:crimson">
                         {{ expirationDateString }} <i class="fa fa-exclamation"></i>
                   </div>
                   {{/expirationDateString }}
            </div>
        </a>
    </li>
    {{/Items}}
             {{^Items}}
             <li>Nessuna</li>
             {{/Items}}
</script>
<script type="text/html" id="BPMClosedItems">
    {{#Items}}
    <li id="{{ id }}" style="display:flex;">
        <a href="#" onclick="openTask({{ id }})" style="display:flex;flex-direction:row;flex-grow:1;border-bottom:1px dashed #ddd;align-items: flex-start;">
            <img src="/internalapi/identity/avatar/0{{ userId }}" class="avatarInList" style="margin-right:4px;" />
            <div style="display:flex;flex-direction:column;width:100%;position:relative">
                    <b style="margin-bottom:-6px">{{ userName }}</b>
                    <div style="font-size:.85rem;font-weight:600">
                        DA: {{ taskItemInfo.senderName }} / {{ roleName }} / {{ groupName }}
                    </div>

                   {{#taskItemInfo.process.description}}
                   <div style="font-size:.85rem;color:#226;font-weight:700;margin-top:4px">
                        <i class="fa fa-sitemap"></i> {{&taskItemInfo.process.description }}
                   </div>
                   {{/taskItemInfo.process.description}}
                   <div style="color: #222;font-size:.85rem" title="Titolo dell'attività"><i class="fa fa-comment" ></i> {{&taskItemInfo.title }}</div>
                   {{#taskItemInfo.progress.length}}
                   <div style="font-size:.85rem;color:#444;font-weight:700"  title="Esito dell'attività">
                        <i class="fa fa-check"></i> 
                        {{#taskItemInfo.event.description }} 
                          {{&taskItemInfo.event.description }}:
                        {{/taskItemInfo.event.description }}

                        {{&taskItemInfo.progress.0.message }}
                   </div>
                   {{/taskItemInfo.progress.length}}

                   <div style="position:absolute;top:2px;right:170px;text-align:right;font-size:.85rem;color:#888" title="Percentuale di completamento dell'attività">
                         {{ percentage }}%
                   </div>

                   <div style="position:absolute;top:2px;right:0px; text-align:right;font-size:.85rem;color:#888" title="Data creazione dell'attività">
                         {{ creationDateString }} <i class="fa fa-calendar"></i>
                   </div>

                   {{#expirationDateString }}
                   <div style="position:absolute;top:54px;right:0px; text-align:right;font-size:.85rem;color:crimson" title="Data scadenza dell'attività">
                         {{ expirationDateString }} <i class="fa fa-exclamation"></i>
                   </div>
                   {{/expirationDateString }}

                   {{#executionDateString }}
                   <div style="position:absolute;top:28px;right:0px; text-align:right;font-size:.85rem;color:#888" title="Data completamento dell'attività">
                         {{ executionDateString }} <i class="fa fa-check"></i>
                   </div>
                   {{/executionDateString }}

            </div>
        </a>
    </li>
    {{/Items}}
             {{^Items}}
             <li>Nessuna</li>
             {{/Items}}
</script>

<script>
    $(document).ready(() => {
        $(".Folders").addClass("active");

        const imageViewer = document.getElementById('documentImage');

        var parentPanel = $(".Histories").parent();
        parentPanel.on("scroll", () => {
            if (parentPanel[0].scrollTop + parentPanel[0].clientHeight > parentPanel[0].scrollHeight * .80) {
                LoadHistoryPage();
            }
        })
        UpdateTaskPanel();
        getCustomActions();
    });

    function EditForm() {
        // if (window.parent) {
             window.OpenModal('/EditForm?documentId=@(Model.Document.Id)');
        // }
        //  else
        // window.location = ('/EditForm?documentId=@(Model.Document.Id)');
    }


  
    function getCustomActions() {
        fetch("/internalapi/wf/getCustomActions/@Model.DocumentId")
            .then(response => {
                if (response.ok)
                    return response.json();
                throw new Error(response.statusText);
            })
            .then(data => {
                if (data && data.value) {
                    var actions = data.value.length;
                    var panel = $(".customActions");
                    var ul = $(".customActionList");
                    if (actions) {
                        var list = "";
                        panel.removeClass("hidden");
                        data.value.forEach((e) => {
                            list += '<li><a title="' + e.tooltip + '" href="#" onclick="startCustomAction(\'' + e.action + '\')"><i class="' + e.icon + '"></i>' + e.label + '</a></li>';
                        });
                        ul.html(list);
                    }
                }
            });

    }

    function startCustomAction(action) {
        fetch("/internalapi/wf/startCustomAction?documentId=@Model.DocumentId&action=" + action)
            .then(response => { return response.json(); })
            .then(data => {
                /*
                 * dovrebbe ritornare l'id del processo da monitorare
                 * In assenza di Id l'azione potrebbe avere inviato un messaggio
                 * Se la proprietà Error non è vuota, viene mostrato l'errore.
                 */
                if (data.Error) {
                    alert(data.Error);
                } else
                    if (data.BpmnProcessId) {
                        OpenModal("/PostSave?Id=" + Model.DocumentId)
                    }
            })

    }

    function ShowPanel(panelToShow) {
        var panel = $(".LeftPanel");
        panel.addClass("hidden");
        $(".link-list li").removeClass("active");
        if (panelToShow) {
            $("." + panelToShow).removeClass("hidden");
            $(".Menu" + panelToShow).addClass("active");
            var RefreshCallback = "Update" + panelToShow;
            if (window[RefreshCallback] != undefined)
                window[RefreshCallback]();
        }
        let element = window;
        element.dispatchEvent(new Event('resize', { 'bubbles': true }));

        return false;
    }
    function ShowPreview(documentId, imageId) {
        if (!imageId) imageId = "";
        OpenModal("/?modalview=S&imageId=" + imageId + "&id=" + documentId);
    }

    var Events = 0;
    var HistoryPage = 0;
    var HistoryLoading = false;
    var HistoryLoaded = 0;

    function FilterHistory(eventId) {
        if (eventId) Events = eventId; else Events = 0;

        $(".HistoryFilters li i.fa-check").addClass("hidden");
        $(".HistoryFilters li i.filter" + Events).removeClass("hidden");

        LoadHistory(true, false);
    }
    function LoadHistoryPage() {
        LoadHistory(false, false);
    }
    function LoadHistory(Reset, Print) {
        if (HistoryLoading) return;
        if (!Reset && HistoryLoaded == 0) return;
        HistoryLoading = true;
        HistoryPage = Print ? -1 : Reset ? 0 : HistoryPage + 1;
        $(".HistoryLoader").removeClass("hidden");
        var searchText = $(".HistorySearchText").val();
        fetch("?handler=Histories&documentId=@Model.DocumentId&PageIndex=" + HistoryPage + "&SearchText=" + searchText + "&Events=" + Events)
            .then(response => { return response.json(); })
            .then(data => {
                var template = $("#Histories").html();
                var html = Mustache.to_html(template, { HistoryEntries: data });
                HistoryLoaded = data.length;
                if (Reset) {
                    HistoryPage = 0;
                    $(".Histories").html(html);
                }
                else {
                    $(".Histories").append(html);
                }
                HistoryLoading = false;
                $(".HistoryLoader").addClass("hidden");

                if (Print == "Y")
                    window.print();
            })
    }

    function AddSign() {
        OpenModal("/AddSign?documents=@Model.DocumentId")
    }
    function PasteToAttachment(documentId) {
        return PasteToLink(documentId, true)
    }
    function PasteToLink(documentId, IsAttachment) {
        var clipboardstring = localStorage.getItem("clipboard");
        var Added = 0;
        var selected = JSON.parse(clipboardstring);
        if (selected) {
            Added = selected.length;
            if (confirm("Sei sicuro di voler incollare " + Added + " documenti come " + (IsAttachment ? "Allegati" : "Collegati") + " ?")) {
                localStorage.removeItem("clipboard");
                fetch("/internalapi/action/PasteAsLink?documentIds=" + clipboardstring + "&masterId=" + documentId + "&isAttachment=" + IsAttachment)
                    .then(response => { return response.json(); })
                    .then(data => {
                        if (Added > 1)
                            msg = Added + " documenti incollati dagli appunti.";
                        else
                            if (Added == 1)
                                msg = Added + " documento incollato dagli appunti.";
                        if (IsAttachment)
                            UpdateAttachmentPanel();
                        else
                            UpdateLinkPanel();
                        alert(msg);
                    });
            }
        } else {
            msg = "Nessun documento trovato negli appunti.";
            alert(msg);
        }
    }
    function DeleteDocument(documentId) {
        if (!confirm("Stai per cancellare questo documento.\nSei sicuro ?"))
        var justification = $("#DeleteJustification").val();
        var recursive = $("#DeleteRecursive:checked").length > 0;
        return Delete(documentId, justification, recursive);
    }
    function RestoreVersion(documentId, imageId) {
        if (confirm("Sei sicuro di voler recuperare questa versione ?")) {
            fetch("?handler=RestoreVersion&documentId=" + documentId + "&imageId=" + imageId)
                .then(response => { return response.json(); })
                .then(data => {
                    window.location.reload();
                });
        }
        return false;
    }

    function UpdateFolderPanel() {
        $(".FoldersPanel").html("Caricamento in corso...");
        fetch("?handler=Folders&documentId=@Model.DocumentId")
            .then(response => { return response.json(); })
            .then(data => {
                var template = $("#FoldersPanel").html();
                var html = Mustache.to_html(template, { Folders: data });
                $(".FoldersPanel").html(html);
                if (data.length > 0)
                    $(".badgeFolders").removeClass("hidden").html(data.length);
                else
                    $(".badgeFolders").addClass("hidden").html(data.length);
            })
    }
    function UpdateHistoryPanel() {
        FilterHistory();
    }
    function UpdateAuthPanel() {
        $(".Permissions").html("Caricamento in corso...");
        fetch("?handler=Permissions&documentId=@Model.DocumentId")
            .then(response => { return response.json(); })
            .then(data => {
                data.forEach(e => {
                    e.profile = e.profile.replace('\\', '\\\\');
                    e.profilePanelId = e.profileType + e.profileId.replaceAll('.', '_').replaceAll('\\', '_').replaceAll(' ', '_')
                });
                var template = $("#Permissions").html();
                var html = Mustache.to_html(template, { Permissions: data });
                $(".Permissions").html(html);
            })
    }
    function UpdateAttachmentPanel() {
        $(".Attachments").html("Caricamento in corso...");
        fetch("?handler=Attachments&documentId=@Model.DocumentId")
            .then(response => { return response.json(); })
            .then(data => {
                var template = $("#Attachments").html();
                var html = Mustache.to_html(template, { Attachments: data });
                $(".Attachments").html(html);
            })
    }
    function UpdateAttachmentOfPanel() {
        $(".Attachments").html("Caricamento in corso...");
        fetch("?handler=AttachmentsOf&documentId=@Model.DocumentId")
            .then(response => { return response.json(); })
            .then(data => {
                var template = $("#Attachments").html();
                var html = Mustache.to_html(template, { Attachments: data });
                $(".AttachmentsOf").html(html);
            })
    }
    function UpdateLinkPanel() {
        $(".Links").html("Caricamento in corso...");
        fetch("?handler=Links&documentId=@Model.DocumentId")
            .then(response => { return response.json(); })
            .then(data => {
                var template = $("#Links").html();
                var html = Mustache.to_html(template, { Links: data });
                $(".Links").html(html);
            })
    }
    function UpdateTaskPanel() {
        $(".TaskList").html("Caricamento in corso...");
        fetch("?handler=Tasks&documentId=@Model.DocumentId")
            .then(response => { return response.json(); })
            .then(data => {
                var template = $("#TaskItems").html();
                $(data).each((i, e) => {
                    e.creationDateString = e.creationDate.substring(0, 10) + " " + e.creationDate.substring(11, 16)
                    e.expirationDateString = e.expirationDate != undefined  ? e.expirationDate.substring(0, 10) : "";
                })
                var html = Mustache.to_html(template, { Items: data });
                $(".TaskList").html(html);
                if (data.length > 0) {
                    $(".MenuTasksPanel").removeClass("hidden");
                    $(".badgeTasks").text(data.length);
                }
                else
                    $(".MenuTasksPanel").addClass("hidden");
            })
    }
    
    function EditPermissions(profile) {
        OpenModal("/Permissions?id=[@Model.DocumentId]&Profile=" + profile, () => {
        });
    }

    function RemovePermissions(profile) {
      fetch("/internalapi/Document/RemovePermissions?documentId=@(Model.DocumentId)&profile="+escape (profile))
            .then(response => { return response.text(); })
            .then(data => {
                UpdateAuthPanel();
            })
    }

    function ChangeDocumentType() {
        OpenModal("/ChooseType?IdCategoria=@Model.Document.DocumentType.CategoryId&DocId=@Model.DocumentId");
    }





    window.addEventListener("message", (event) => {
        if (event.data.op == "addfolder") {
            UpdateFolderPanel();
        } else
            if (event.data.op == "addlink") {
                UpdateLinkPanel();
            }
            else
                if (event.data.op == "close" || event.data.op == "closeTask") {
                    if (window.Modal)
                    {
                        $(window.Modal).find("#PopupWindow").attr("src", "");
                        $(window.Modal).addClass("hidden");
                        window.Modal = undefined;
                    }
                }
                else
                    if (event.data.op == "checkin") {
                        window.location.reload(true);
                    } else
                        if (event.data.op == "addattachment") {
                            UpdateAttachmentPanel();
                        } else
                            if (event.data.op == "addauth") {
                                UpdateAuthPanel();
                            } else
                                if (event.data.op == "addauth") {
                                    UpdateAuthPanel();
                                } else
                                    if (event.data.op == "updateTask" || event.data.op == "getNextTask") {

                                        if (window.Modal)
                                        {
                                            $(window.Modal).find("#PopupWindow").attr("src", "");
                                            $(window.Modal).addClass("hidden");
                                            window.Modal = undefined;
                                        }
                                        UpdateTaskPanel();
                                        UpdateBPMPanel();
                                    } else
                                        if (event.data.op == "storicize") {
                                        window.location.reload(true);
                                    } else
                                        if (event.data.op == "activate") {
                                        window.location.reload(true);
                                    } else
                                        if (event.data.op == "restore") {
                                            window.location.reload(true);
                                        } else
                                            if (event.data.op == "delete") {
                                                window.location.reload(true);
                                            } else
                                                if (event.data.op == "newdocument") {
                                                    window.location.href = "?id=" + event.data.data;
                                                } else
                                                    if (event.data.op == "digitalsign") {
                                                        window.location.href = "?id=" + event.data.data;
                                                    } else
                                                        if (event.data.op == "removefolder") {
                                                            var template = $("#Folders").html();
                                                            // Se sono nella scheda documento...
                                                            if (template) {
                                                                UpdateFolderPanel();
                                                            }
                                                            else
                                                                window.location.reload(true);
                                                        } else
                                                        if (event.data.op == "refresh") {
                                                            if (window.Modal)
                                                            {
                                                                $(window.Modal).find("#PopupWindow").attr("src", "");
                                                                $(window.Modal).addClass("hidden");
                                                                window.Modal = undefined;
                                                            }
                                                            window.location.reload();
                                                        }
        if (!$(".HistoryPanel").hasClass("hidden"))
            UpdateHistoryPanel();

    })

</script>



<script src="/components/ImageViewer/dist/image-viewer.js" type="module"></script>


